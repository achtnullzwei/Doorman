# Debug Utilities Addon

substitutions:
  log_level: "DEBUG"

logger:
  logs:
    tc_bus: DEBUG
  #  component: ERROR # avoids component warning spam
    sensor: DEBUG

remote_receiver:
  dump: raw
  
globals:
  - id: search_mode
    type: int
    restore_value: no
    initial_value: "0"

  - id: as_list
    type: std::vector<int>
    initial_value: ''

  - id: is0_list
    type: std::vector<int>
    initial_value: ''

  - id: is1_list
    type: std::vector<int>
    initial_value: ''

  - id: extra_list
    type: std::vector<int>
    initial_value: ''
    
binary_sensor:
  - platform: template
    id: debug_bus_connected
    name: "Bus Connection Status"
    icon: "mdi:connection"
    disabled_by_default: true
    lambda: |-
      if (id(debug_bus_voltage).state >= 2.8) {
        return true;
      } else {
        return false;
      }
    entity_category: DIAGNOSTIC
    web_server:
      sorting_group_id: sorting_group_debug_tools

  - id: !extend doorman_boot_button
    internal: false
    

sensor:
  - platform: adc
    id: debug_bus_voltage
    name: "Bus Voltage"
    pin: ${adc_input_pin}
    update_interval: 5s
    attenuation: 12dB
    entity_category: DIAGNOSTIC
    disabled_by_default: true
    icon: "mdi:current-dc"
    web_server:
      sorting_group_id: sorting_group_debug_tools
      sorting_weight: -5

text:
  - platform: template
    id: debug_send_command
    name: "Send Command"
    icon: "mdi:send"
    mode: text
    disabled_by_default: true
    optimistic: true
    set_action: 
      then: 
        - lambda: |-
            x.erase(std::remove_if(x.begin(), x.end(), [](char c) { return !std::isxdigit(c); }), x.end());
            x.erase(0, x.find_first_not_of('0'));
            x.resize(8);
            unsigned long number = 0;
            if(std::string(x.c_str()) != "") {
              number = std::stoul(x.c_str(), nullptr, 16);
            }
            id(tc_bus_intercom)->send_command(number);
    web_server:
      sorting_group_id: sorting_group_debug_tools

button:
  - platform: template
    id: debug_restart_control_unit
    name: "System Restart"
    icon: mdi:restart
    disabled_by_default: true
    on_press:
      - tc_bus.send:
          type: reset
    web_server:
      sorting_group_id: sorting_group_debug_tools

  - platform: template
    id: debug_system_discovery
    name: "System Discovery"
    icon: "mdi:home-search"
    disabled_by_default: true
    on_press: 
      # Clear Lists
      - lambda: |-
          id(as_list).clear();
          id(is0_list).clear();
          id(is1_list).clear();
      - light.turn_on:
          id: doorman_rgb_status_led
          red: 100%
          green: 45%
          blue: 83%
          effect: pulse
      # Search Outdoor Stations
      - logger.log: Search outdoor stations...
      - tc_bus.send:
          type: select_device_group
          payload: 2
      - globals.set:
          id: search_mode
          value: "1"
      - delay: 350ms
      - tc_bus.send:
          type: search_devices
      # Wait until every outdoor station sent response
      - delay: 5s
      # Search Indoor Stations 0
      - logger.log: Search indoor stations (0)...
      - globals.set:
          id: search_mode
          value: "2"
      - tc_bus.send:
          type: select_device_group
          payload: 0
      - delay: 350ms
      - tc_bus.send:
          type: search_devices
      # Wait until every indoor station sent response
      - delay: 10s
      # Search Indoor Stations 1
      - logger.log: Search indoor stations (1)...
      - globals.set:
          id: search_mode
          value: "3"
      - tc_bus.send:
          type: select_device_group
          payload: 1
      - delay: 350ms
      - tc_bus.send:
          type: search_devices
      # Wait until every indoor station sent response
      - delay: 10s
      # Search Extras
      - logger.log: Search extras (6)...
      - globals.set:
          id: search_mode
          value: "4"
      - tc_bus.send:
          type: select_device_group
          payload: 6
      - delay: 350ms
      - tc_bus.send:
          type: search_devices
      # Wait until every indoor station sent response
      - delay: 10s
      # Complete
      - globals.set:
          id: search_mode
          value: "0"
      - logger.log:
          format: "Search complete! Found %i outdoor station(s), %i type 0 indoor station(s), %i type 1 indoor station(s) and , %i extra(s)."
          args: [ 'id(as_list).size()', 'id(is0_list).size()', 'id(is1_list).size()', 'id(extra_list).size()']
          level: info
      - lambda: |-
          for (const auto& value : id(as_list))
          {
            ESP_LOGI("DEBUG", "AS (2): %d", value);
          }

          for (const auto& value : id(is0_list))
          {
            ESP_LOGI("DEBUG", "IS (0): %d", value);
          }

          for (const auto& value : id(is1_list))
          {
            ESP_LOGI("DEBUG", "IS (1): %d", value);
          }

          for (const auto& value : id(extra_list))
          {
            ESP_LOGI("DEBUG", "EXTRA (6): %d", value);
          }
      - light.turn_on:
          id: doorman_rgb_status_led
          red: 100%
          green: 45%
          blue: 83%
          effect: none
          color_brightness: !lambda return id(doorman_rgb_status_led_brightness).state / 100.0;
      - delay: 3s
      - script.execute: update_led
    web_server:
      sorting_group_id: sorting_group_debug_tools

# Extend TC:BUS Component
tc_bus:
  on_command:
    - if:
        condition:
          - lambda: |-
              return x.type == COMMAND_TYPE_FOUND_DEVICE && id(search_mode) != 0;
        then:
          - lambda: |-
              std::vector<int>* list_ptr = nullptr;

              int mode = id(search_mode);
              if (mode == 1) {
                  list_ptr = &id(as_list);
              } else if (mode == 2) {
                  list_ptr = &id(is0_list);
              } else if (mode == 3) {
                  list_ptr = &id(is1_list);
              } else if (mode == 4) {
                  list_ptr = &id(extra_list);
              } else {
                  list_ptr = &id(extra_list);
              }

              std::vector<int>& list = *list_ptr;

              bool found = false;
              for (const auto& s : list) {
                if (s == x.serial_number) {
                  found = true;
                  break;
                }
              }
              if (!found) {
                list.push_back(x.serial_number);
              }