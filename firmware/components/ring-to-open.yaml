# Ring To Open Addon

binary_sensor:
  - id: !extend entrance_doorbell
    on_press:
      - if:
          condition:
            - switch.is_on: rto_entrance_door
            - lambda: !lambda 'return id(rto_entrance_door_pattern_condition).state == "single";'
          then:
            # Deactivate Ring To Open when Ring once is selected
            - if:
                condition:
                  - lambda: !lambda 'return id(rto_entrance_door_timeout_mode).state == "Ring once";'
                then:
                  - switch.turn_off: rto_entrance_door

            - if:
                condition:
                  - lambda: !lambda 'return id(rto_entrance_door_delay).state == "Random";'
                then:
                  - delay: !lambda "return 5000 + (rand() % 10000);"
                else:
                  - delay: !lambda |-
                      std::string str = id(rto_entrance_door_delay).state;
                      size_t pos = str.find(' ');
                      std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                      int value = std::stoi(first_token);
                      return value * 1000 + 300;

            - script.execute: rto_entrance_door_action

  - id: !extend second_entrance_doorbell
    on_press:
      - if:
          condition:
            - switch.is_on: rto_second_entrance_door
            - lambda: !lambda 'return id(rto_second_entrance_door_pattern_condition).state == "single";'
          then:
            # Deactivate Ring To Open when Ring once is selected
            - if:
                condition:
                  - lambda: !lambda 'return id(rto_second_entrance_door_timeout_mode).state == "Ring once";'
                then:
                  - switch.turn_off: rto_second_entrance_door

            - if:
                condition:
                  - lambda: !lambda 'return id(rto_second_entrance_door_delay).state == "Random";'
                then:
                  - delay: !lambda "return 5000 + (rand() % 10000);"
                else:
                  - delay: !lambda |-
                      std::string str = id(rto_second_entrance_door_delay).state;
                      size_t pos = str.find(' ');
                      std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                      int value = std::stoi(first_token);
                      return value * 1000 + 300;

            - script.execute: rto_second_entrance_door_action

  - id: !extend apartment_doorbell
    on_press:
      - if:
          condition:
            - switch.is_on: rto_apartment_door
            - lambda: !lambda 'return id(rto_apartment_door_pattern_condition).state == "single";'
          then:
            # Deactivate Ring To Open when Ring once is selected
            - if:
                condition:
                  - lambda: !lambda 'return id(rto_apartment_door_timeout_mode).state == "Ring once";'
                then:
                  - switch.turn_off: rto_apartment_door

            - if:
                condition:
                  - lambda: !lambda 'return id(rto_apartment_door_delay).state == "Random";'
                then:
                  - delay: !lambda "return 5000 + (rand() % 10000);"
                else:
                  - delay: !lambda |-
                      std::string str = id(rto_apartment_door_delay).state;
                      size_t pos = str.find(' ');
                      std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                      int value = std::stoi(first_token);
                      return value * 1000 + 300;

            - script.execute: rto_apartment_door_action

  - id: !extend doorman_external_button
    on_press:
      - if:
          condition:
            - lambda: !lambda 'return id(rto_toggle_trigger).state == "External Button";'
          then:
            - switch.toggle: rto_central
            - delay: 300ms

            # Confirm Ring To Open activation
            # Ring Apartment Doorbell once
            - if: 
                condition:
                  - switch.is_on: rto_central
                  - switch.is_on: rto_confirmation
                then:
                  - tc_bus.send:
                      type: floor_call

            # Reset to prevent address conflict
            - tc_bus.send:
                type: reset

  - id: !extend function_button
    on_press:
      - if:
          condition:
            - lambda: !lambda 'return id(rto_toggle_trigger).state == "Function Button";'
          then:
            - switch.toggle: rto_central
            - delay: 300ms

            # Confirm Ring To Open activation
            # Ring Apartment Doorbell once
            - if: 
                condition:
                  - switch.is_on: rto_central
                  - switch.is_on: rto_confirmation
                then:
                  - tc_bus.send:
                      type: floor_call

            # Reset to prevent address conflict
            - tc_bus.send:
                type: reset


event:
  - id: !extend entrance_doorbell_pattern
    on_event:
      # Ring To Open Action
      - if:
          condition:
            - switch.is_on: rto_entrance_door
            - lambda: !lambda 'return event_type.c_str() != "single";'
            - lambda: !lambda 'return event_type.c_str() == id(rto_entrance_door_pattern_condition).state;'
          then:
            # Deactivate Ring To Open when Ring once is selected
            - if:
                condition:
                  - lambda: !lambda 'return id(rto_entrance_door_timeout_mode).state == "Ring once";'
                then:
                  - switch.turn_off: rto_entrance_door

            - if:
                condition:
                  - lambda: !lambda 'return id(rto_entrance_door_delay).state == "Random";'
                then:
                  - delay: !lambda "return 5000 + (rand() % 10000);"
                else:
                  - delay: !lambda |-
                      std::string str = id(rto_entrance_door_delay).state;
                      size_t pos = str.find(' ');
                      std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                      int value = std::stoi(first_token);

                      // Subtract 2 seconds for the pattern offset
                      if(value < 2)
                      {
                        value = 2;
                      }
                      return (value - 2) * 1000;

            - script.execute: rto_entrance_door_action


  - id: !extend second_entrance_doorbell_pattern
    on_event:
      # Ring To Open Action
      - if:
          condition:
            - switch.is_on: rto_second_entrance_door
            - lambda: !lambda 'return event_type.c_str() != "single";'
            - lambda: !lambda 'return event_type.c_str() == id(rto_second_entrance_door_pattern_condition).state;'
          then:
            # Deactivate Ring To Open when Ring once is selected
            - if:
                condition:
                  - lambda: !lambda 'return id(rto_second_entrance_door_timeout_mode).state == "Ring once";'
                then:
                  - switch.turn_off: rto_second_entrance_door

            - if:
                condition:
                  - lambda: !lambda 'return id(rto_second_entrance_door_delay).state == "Random";'
                then:
                  - delay: !lambda "return 5000 + (rand() % 10000);"
                else:
                  - delay: !lambda |-
                      std::string str = id(rto_second_entrance_door_delay).state;
                      size_t pos = str.find(' ');
                      std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                      int value = std::stoi(first_token);

                      // Subtract 2 seconds for the pattern offset
                      if(value < 2)
                      {
                        value = 2;
                      }
                      return (value - 2) * 1000;

            - script.execute: rto_second_entrance_door_action

  - id: !extend apartment_doorbell_pattern
    on_event:
      # Ring To Open Action
      - if:
          condition:
            - switch.is_on: rto_apartment_door
            - lambda: !lambda 'return event_type.c_str() != "single";'
            - lambda: !lambda 'return event_type.c_str() == id(rto_apartment_door_pattern_condition).state;'
          then:
            # Deactivate Ring To Open when Ring once is selected
            - if:
                condition:
                  - lambda: !lambda 'return id(rto_apartment_door_timeout_mode).state == "Ring once";'
                then:
                  - switch.turn_off: rto_apartment_door

            - if:
                condition:
                  - lambda: !lambda 'return id(rto_apartment_door_delay).state == "Random";'
                then:
                  - delay: !lambda "return 5000 + (rand() % 10000);"
                else:
                  - delay: !lambda |-
                      std::string str = id(rto_apartment_door_delay).state;
                      size_t pos = str.find(' ');
                      std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                      int value = std::stoi(first_token);
                      
                      // Subtract 2 seconds for the pattern offset
                      if(value < 2)
                      {
                        value = 2;
                      }
                      return (value - 2) * 1000;

            - script.execute: rto_apartment_door_action

switch:
  # Global Setting
  - platform: template
    id: rto_central
    name: "Ring To Open"
    icon: "mdi:checkbox-marked-circle-auto-outline"
    restore_mode: RESTORE_DEFAULT_OFF
    lambda: |-
      if(id(rto_central_doors).state == "Entrance") {
        return id(rto_entrance_door).state;
      } else if(id(rto_central_doors).state == "Second Entrance") {
        return id(rto_second_entrance_door).state;
      } else if(id(rto_central_doors).state == "Any Entrance") {
        return id(rto_entrance_door).state || id(rto_second_entrance_door).state;
      } else if(id(rto_central_doors).state == "Apartment") {
        return id(rto_apartment_door).state;
      } else if(id(rto_central_doors).state == "Any Entrance & Apartment") {
        return id(rto_entrance_door).state || id(rto_second_entrance_door).state || id(rto_apartment_door).state;
      }
      return false;
    turn_on_action:
      - lambda: |-
          if(id(rto_central_doors).state == "Entrance") {
            id(rto_entrance_door).turn_on();
          } else if(id(rto_central_doors).state == "Second Entrance") {
            id(rto_second_entrance_door).turn_on();
          } else if(id(rto_central_doors).state == "Any Entrance") {
            id(rto_entrance_door).turn_on();
            id(rto_second_entrance_door).turn_on();
          } else if(id(rto_central_doors).state == "Apartment") {
            id(rto_apartment_door).turn_on();
          } else if(id(rto_central_doors).state == "Any Entrance & Apartment") {
            id(rto_entrance_door).turn_on();
            id(rto_second_entrance_door).turn_on();
            id(rto_apartment_door).turn_on();
          }
    turn_off_action:
      - lambda: |-
          if(id(rto_central_doors).state == "Entrance") {
            id(rto_entrance_door).turn_off();
          } else if(id(rto_central_doors).state == "Second Entrance") {
            id(rto_second_entrance_door).turn_off();
          } else if(id(rto_central_doors).state == "Any Entrance") {
            id(rto_entrance_door).turn_off();
            id(rto_second_entrance_door).turn_off();
          } else if(id(rto_central_doors).state == "Apartment") {
            id(rto_apartment_door).turn_off();
          } else if(id(rto_central_doors).state == "Any Entrance & Apartment") {
            id(rto_entrance_door).turn_off();
            id(rto_second_entrance_door).turn_off();
            id(rto_apartment_door).turn_off();
          }
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 5

  # Setting for each Door - Entrance Door
  - platform: template
    id: rto_entrance_door
    name: "RTO: Entrance Door"
    icon: "mdi:checkbox-marked-circle-auto-outline"
    restore_mode: RESTORE_DEFAULT_OFF
    disabled_by_default: true
    optimistic: true
    turn_on_action:
      - script.execute: rto_entrance_door_timer
    turn_off_action:
      - script.stop: rto_entrance_door_timer
    on_turn_on:
      - script.execute: update_led
    on_turn_off:
      - script.execute: update_led
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -80

  # Setting for each Door - Second Entrance Door
  - platform: template
    id: rto_second_entrance_door
    name: "RTO: Second Entrance Door"
    icon: "mdi:checkbox-marked-circle-auto-outline"
    restore_mode: RESTORE_DEFAULT_OFF
    disabled_by_default: true
    optimistic: true
    turn_on_action:
      - script.execute: rto_second_entrance_door_timer
    turn_off_action:
      - script.stop: rto_second_entrance_door_timer
    on_turn_on:
      - script.execute: update_led
    on_turn_off:
      - script.execute: update_led
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -70

  # Setting for each Door - Apartment Door
  - platform: template
    id: rto_apartment_door
    name: "RTO: Apartment Door"
    disabled_by_default: true
    internal: true
    icon: "mdi:checkbox-marked-circle-auto-outline"
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    turn_on_action:
      - script.execute: rto_apartment_door_timer
    turn_off_action:
      - script.stop: rto_apartment_door_timer
    on_turn_on:
      - script.execute: update_led
    on_turn_off:
      - script.execute: update_led
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -50

  # Global Setting for all Doors
  - platform: template
    id: rto_confirmation
    name: "RTO: Confirmation"
    icon: "mdi:bell-check"
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    entity_category: CONFIG
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -100

  # Global Setting for all Doors
  - platform: template
    id: rto_led_status
    name: "RTO: Display Status"
    icon: "mdi:led-on"
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: CONFIG
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -99

select:
  - platform: template
    id: rto_central_doors
    name: "RTO: Central Toggle - Door Selection"
    icon: "mdi:door"
    optimistic: true
    options:
      - "Entrance"
      - "Second Entrance"
      - "Any Entrance"
      - "Apartment"
      - "Any Entrance & Apartment"
    initial_option: "Entrance"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -89

  - platform: template
    name: "RTO: Entrance Door - Delay"
    id: rto_entrance_door_delay
    disabled_by_default: true
    icon: "mdi:clock-end"
    optimistic: true
    options:
      - "0 seconds"
      - "1 second"
      - "2 seconds"
      - "3 seconds"
      - "4 seconds"
      - "5 seconds"
      - "10 seconds"
      - "15 seconds"
      - "20 seconds"
      - "25 seconds"
      - "Random"
    initial_option: "2 seconds"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -78

  - platform: template
    name: "RTO: Second Entrance Door - Delay"
    id: rto_second_entrance_door_delay
    disabled_by_default: true
    icon: "mdi:clock-end"
    optimistic: true
    options:
      - "0 seconds"
      - "1 second"
      - "2 seconds"
      - "3 seconds"
      - "4 seconds"
      - "5 seconds"
      - "10 seconds"
      - "15 seconds"
      - "20 seconds"
      - "25 seconds"
      - "Random"
    initial_option: "2 seconds"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -68

  - platform: template
    name: "RTO: Apartment Door - Delay"
    id: rto_apartment_door_delay
    internal: true
    disabled_by_default: true
    icon: "mdi:clock-end"
    optimistic: true
    options:
      - "0 seconds"
      - "1 second"
      - "2 seconds"
      - "3 seconds"
      - "4 seconds"
      - "5 seconds"
      - "10 seconds"
      - "15 seconds"
      - "20 seconds"
      - "25 seconds"
      - "Random"
    initial_option: "2 seconds"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -48

  # Setting for each Door - Entrance Door
  - platform: template
    id: rto_entrance_door_timeout_mode
    name: "RTO: Entrance Door - Timeout"
    icon: "mdi:clock-fast"
    optimistic: true
    options:
      - "Never"
      - "Ring once"
      - "5 minutes"
      - "10 minutes"
      - "15 minutes"
      - "20 minutes"
      - "25 minutes"
      - "30 minutes"
      - "35 minutes"
      - "40 minutes"
      - "45 minutes"
      - "50 minutes"
      - "55 minutes"
      - "60 minutes"
    initial_option: "Never"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -77

  # Setting for each Door - Second Entrance Door
  - platform: template
    id: rto_second_entrance_door_timeout_mode
    name: "RTO: Second Entrance Door - Timeout"
    icon: "mdi:clock-fast"
    disabled_by_default: true
    optimistic: true
    options:
      - "Never"
      - "Ring once"
      - "5 minutes"
      - "10 minutes"
      - "15 minutes"
      - "20 minutes"
      - "25 minutes"
      - "30 minutes"
      - "35 minutes"
      - "40 minutes"
      - "45 minutes"
      - "50 minutes"
      - "55 minutes"
      - "60 minutes"
    initial_option: "Never"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -67

  # Setting for each Door - Apartment Door
  - platform: template
    id: rto_apartment_door_timeout_mode
    internal: true
    name: "RTO: Apartment Door - Timeout"
    icon: "mdi:clock-fast"
    optimistic: true
    options:
      - "Never"
      - "Ring once"
      - "5 minutes"
      - "10 minutes"
      - "15 minutes"
      - "20 minutes"
      - "25 minutes"
      - "30 minutes"
      - "35 minutes"
      - "40 minutes"
      - "45 minutes"
      - "50 minutes"
      - "55 minutes"
      - "60 minutes"
    initial_option: "Never"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -47

  # Setting for each Door - Entrance Door
  - platform: template
    id: rto_entrance_door_pattern_condition
    name: "RTO: Entrance Door - Pattern"
    icon: "mdi:gesture-tap-button"
    disabled_by_default: true
    optimistic: true
    options:
      - "single"
      - "double"
      - "triple"
      - "quadruple"
    initial_option: "single"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -79

  # Setting for each Door - Second Entrance Door
  - platform: template
    id: rto_second_entrance_door_pattern_condition
    name: "RTO: Second Entrance Door - Pattern"
    icon: "mdi:gesture-tap-button"
    disabled_by_default: true
    optimistic: true
    options:
      - "single"
      - "double"
      - "triple"
      - "quadruple"
    initial_option: "single"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -69

  # Setting for each Door - Apartment Door
  - platform: template
    id: rto_apartment_door_pattern_condition
    name: "RTO: Apartment Door - Pattern"
    internal: true
    icon: "mdi:gesture-tap-button"
    disabled_by_default: true
    optimistic: true
    options:
      - "single"
      - "double"
      - "triple"
      - "quadruple"
    initial_option: "single"
    restore_value: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -49

  # Global Setting
  - platform: template
    id: rto_toggle_trigger
    name: "RTO: Central Toggle - Trigger"
    icon: "mdi:circle-outline"
    optimistic: true
    options:
      - "Manual"
      - "Function Button"
      - "External Button"
    initial_option: "Manual"
    restore_value: true
    entity_category: CONFIG
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -90

script:
  - id: rto_entrance_door_timer
    mode: restart
    then:
      # Turn off Ring To Open Mode after selected time
      - if:
          condition:
            - lambda: |-
                return id(rto_entrance_door_timeout_mode).state != "Never" && 
                       id(rto_entrance_door_timeout_mode).state != "Ring once";
          then:
            - delay: !lambda |-
                std::string str = id(rto_entrance_door_timeout_mode).state;
                size_t pos = str.find(' ');
                std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                int value = std::stoi(first_token);
                ESP_LOGD("main", "RTO: Entrance Door will stay turned on for %i minutes", value);
                return value * 60 * 1000;
            - switch.turn_off: rto_entrance_door

  - id: rto_second_entrance_door_timer
    mode: restart
    then:
      # Turn off Ring To Open Mode after selected time
      - if:
          condition:
            - lambda: |-
                return id(rto_second_entrance_door_timeout_mode).state != "Never" &&
                       id(rto_second_entrance_door_timeout_mode).state != "Ring once";
          then:
            - delay: !lambda |-
                std::string str = id(rto_second_entrance_door_timeout_mode).state;
                size_t pos = str.find(' ');
                std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                int value = std::stoi(first_token);
                ESP_LOGD("main", "RTO: Second Entrance Door will stay turned on for %i minutes", value);
                return value * 60 * 1000;
            - switch.turn_off: rto_second_entrance_door

  - id: rto_apartment_door_timer
    mode: restart
    then:
      # Turn off Ring To Open Mode after selected time
      - if:
          condition:
            - lambda: |-
                return id(rto_apartment_door_timeout_mode).state != "Never" && 
                       id(rto_apartment_door_timeout_mode).state != "Ring once";
          then:
            - delay: !lambda |-
                std::string str = id(rto_apartment_door_timeout_mode).state;
                size_t pos = str.find(' ');
                std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                int value = std::stoi(first_token);
                ESP_LOGD("main", "RTO: Apartment Door will stay turned on for %i minutes", value);
                return value * 60 * 1000;
            - switch.turn_off: rto_apartment_door

  - id: rto_entrance_door_action
    then:
      - lock.unlock: entrance_door

  - id: rto_second_entrance_door_action
    then:
      - lock.unlock: second_entrance_door

  - id: rto_apartment_door_action
    then:
      - logger.log: "RTO: Apartment Door Action Placeholder"

  - id: !extend update_led
    then:
      - if:
          condition:
            - lambda: |-
                return id(rto_entrance_door).state || 
                       id(rto_second_entrance_door).state || 
                       id(rto_apartment_door).state;
            - switch.is_on: rto_led_status
          then:
            # TODO: improve status by using multiple colors / effects
            #       to indicate each RTO status
            - light.turn_on:
                id: doorman_rgb_status_led
                red: 100%
                green: 100%
                blue: 3%
                effect: slow_pulse