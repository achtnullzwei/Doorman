# API: MQTT

globals:
   - id: mqtt_connecting
     type: bool
     restore_value: no
     initial_value: 'false'

web_server:
  sorting_groups:
    - id: sorting_group_mqtt
      name: "MQTT Configuration"
      sorting_weight: -2

text:
  - platform: template
    id: mqtt_broker_address
    name: "MQTT Broker Address"
    icon: "mdi:server"
    optimistic: true
    min_length: 0
    max_length: 30
    mode: text
    restore_value: true
    initial_value : ""
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_mqtt
      sorting_weight: 0

  - platform: template
    id: mqtt_broker_username
    name: "MQTT Username"
    icon: "mdi:shield-account"
    optimistic: true
    min_length: 0
    max_length: 30
    mode: text
    restore_value: true
    initial_value : ""
    entity_category: CONFIG
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_mqtt
      sorting_weight: 2
    
  - platform: template
    id: mqtt_broker_password
    name: "MQTT Password"
    icon: "mdi:shield-lock"
    optimistic: true
    min_length: 0
    max_length: 45
    mode: password
    restore_value: true
    initial_value : ""
    entity_category: CONFIG
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_mqtt
      sorting_weight: 3

number:
  - platform: template
    id: mqtt_broker_port
    name: "MQTT Broker Port"
    icon: "mdi:numeric"
    optimistic: true
    min_value: 0
    max_value: 65535
    step: 1
    mode: box
    restore_value: true
    initial_value: 1883
    entity_category: CONFIG
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_mqtt
      sorting_weight: 1

button:
  - platform: template
    id: mqtt_save_settings
    name: "Save MQTT Configuration"
    icon: "mdi:content-save-check"
    on_press:
      - if:
          condition:
            - lambda: return id(mqtt_connecting) == true || id(mqtt_client).is_connected();
          then:
            - logger.log: "MQTT is connecing or already connected. Disable MQTT and wait 5 seconds..."
            - mqtt.disable:
            - delay: 5s
            - lambda: id(mqtt_connecting) = false;
      - logger.log: "Apply configuration and enable MQTT..."
      - script.execute: mqtt_connect
    web_server:
      sorting_group_id: sorting_group_mqtt
      sorting_weight: 4

mqtt:
  id: mqtt_client
  port: 1883
  broker: ""
  username: ""
  password: ""
  enable_on_boot: false
  discovery: false
  discover_ip: false
  topic_prefix: ${name}
  on_message:
    - topic: ${name}/send_tc_telegram/raw
      then:
        - tc_bus.send:
            telegram: !lambda |-
              size_t pos;
              uint32_t value = std::stoul(x, &pos, 16);
              if (pos != x.length()) {
                  return 0;
              }
              return value;
            is_long: !lambda |-
              return x.length() == 8;

  on_json_message:
    - topic: ${name}/send_tc_telegram
      then:
        - tc_bus.send:
            type: !lambda |-
              TelegramType telegramType = TELEGRAM_TYPE_UNKNOWN;
              if (x.containsKey("type"))
                telegramType = string_to_telegram_type(x["type"]);
              return telegramType;
            address: !lambda |-
              int address = 0;
              if (x.containsKey("address"))
                address = x["address"];
              return address;
            payload: !lambda |-
              int payload = 0;
              if (x.containsKey("payload"))
                payload = x["payload"];
              return payload;
            serial_number: !lambda |-
              int serial_number = 0;
              if (x.containsKey("serial_number"))
                serial_number = x["serial_number"];
              return serial_number;

    - topic: ${name}/send_tc_is_telegram
      then:
        - tc_bus_device.send:
            id: tc_bus_indoor_station
            type: !lambda |-
              TelegramType telegramType = TELEGRAM_TYPE_UNKNOWN;
              if (x.containsKey("type"))
                telegramType = string_to_telegram_type(x["type"]);
              return telegramType;
            address: !lambda |-
              int address = 0;
              if (x.containsKey("address"))
                address = x["address"];
              return address;
            payload: !lambda |-
              int payload = 0;
              if (x.containsKey("payload"))
                payload = x["payload"];
              return payload;

tc_bus:
  on_telegram:
    - mqtt.publish_json:
        topic: ${name}/last_telegram
        payload: |-
          root["telegram"] = x.hex;
          root["type"] = telegram_type_to_string(x.type);
          root["address"] = x.address;
          root["payload"] = x.payload;
          root["serial_number"] = x.serial_number;

script:
  - id: !extend boot_state
    then:
      # WiFi already connected
      - if:
          condition:
            mqtt.connected:
          then:
            - logger.log: "LED: MQTT already connected"
          else:
            - logger.log: "LED: Waiting for MQTT connection"
            - script.execute: mqtt_connect

  - id: mqtt_connect
    mode: restart
    then:
      # Check if Broker data is set
      - if:
          condition:
             - lambda: return id(mqtt_broker_address).state != "";
          then:
            # Regular blue pulse while connecting
            - light.turn_on:
                id: doorman_rgb_status_led
                effect: slow_pulse
                red: 0%
                green: 22%
                blue: 100%

            - logger.log: "Set MQTT credentials..."
            
            # Set broker credentials
            - lambda: |-
                id(mqtt_client).set_broker_address(id(mqtt_broker_address).state.c_str());
                id(mqtt_client).set_broker_port(id(mqtt_broker_port).state);
                id(mqtt_client).set_username(id(mqtt_broker_username).state.c_str());
                id(mqtt_client).set_password(id(mqtt_broker_password).state.c_str());
                global_preferences->sync();
                
                id(mqtt_connecting) = true;

            # Try to connect to MQTT
            - logger.log: "Enable MQTT..."
            - mqtt.enable:
          
          else:
            # Red/Blue pulse because broker data is not set
            - light.turn_on:
                id: doorman_rgb_status_led
                effect: error_api

      - logger.log: "Wait for MQTT connection..."
      - wait_until:
          condition: mqtt.connected

      - logger.log: "MQTT connected!"
      - light.turn_on:
          id: doorman_rgb_status_led
          effect: none
          red: 0%
          green: 22%
          blue: 100%
          #transition_length: 1s
          brightness: !lambda return id(doorman_rgb_status_led_brightness).state / 100.0;

      - delay: 3s

      - script.execute: update_led