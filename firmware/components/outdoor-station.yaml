# Outdoor Station Settings Addon

esphome:
  # Incompatible with indoor station
  # they both want to read memory on boot

  #on_boot:
  #  then:
  #    - if:
  #        condition:
  #           - lambda: return id(outdoor_station_serial_number).state != 0 && id(outdoor_station_model).state != "None";
  #        then:
  #          - tc_bus_device.read_memory:
  #              id: tc_bus_outdoor_station
  
  devices:
    - id: tc_bus_os
      name: "TC:BUS Outdoor Station"

web_server:
  sorting_groups:
    - id: sorting_group_outdoor_station_settings
      name: "Settings - TC:BUS Outdoor Station"
      sorting_weight: -69

tc_bus_device:
  - id: tc_bus_outdoor_station
    type: outdoor_station
    
    on_read_memory_complete:
      - lambda: |-
          std::string hexString = str_upper_case(format_hex(x));
          ESP_LOGI("tc_bus", "Memory reading completed. Data: %s", hexString.c_str());

    on_read_memory_timeout:
      - logger.log:
          format: "Memory reading timed out! No memory block received in time."
          level: ERROR

    on_identify_complete:
      - logger.log:
          format: "Identified Hardware: %s (v%i) | Firmware: %i.%i.%i"
          args: [ 'model_to_string(x.model)', 'x.hardware_version', 'x.firmware_major', 'x.firmware_minor', 'x.firmware_patch' ]
          level: INFO
      - delay: 2s
      - tc_bus_device.read_memory:
          id: tc_bus_outdoor_station

    on_identify_timeout:
      - logger.log:
          format: "Failed to identify the Outdoor Station. Please select it manually."
          level: ERROR

number:
  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_outdoor_station
    serial_number:
      id: outdoor_station_serial_number
      device_id: tc_bus_os
      name: "OS: Serial Number"
      icon: "mdi:numeric"
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_outdoor_station_settings
        sorting_weight: -100

select:
  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_outdoor_station
    model:
      id: outdoor_station_model
      device_id: tc_bus_os
      name: "OS: Model"
      icon: "mdi:doorbell-video"
      entity_category: CONFIG
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_outdoor_station_settings
        sorting_weight: -97

# Read Memory before reading and writing
button:
  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_outdoor_station
    identify_device:
      id: identify_outdoor_station
      device_id: tc_bus_os
      name: "OS: Identify"
      icon: "mdi:identifier"
      entity_category: CONFIG
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_outdoor_station_settings
        sorting_weight: -96

    read_memory:
      id: read_outdoor_station_memory
      device_id: tc_bus_os
      name: "OS: Read Memory"
      icon: "mdi:file-arrow-up-down"
      entity_category: CONFIG
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_outdoor_station_settings
        sorting_weight: -95

  - platform: template
    id: test_doorbell_button_assign
    name: "Test Assignment"
    on_press:
      - tc_bus_device.update_doorbell_button:
          id: tc_bus_outdoor_station
          button_row: 1

  - platform: template
    name: "Read Actions of Doorbell Button 1 via lambda"
    on_press:
      - lambda: |-
          DoorbellButtonConfig button = id(tc_bus_outdoor_station)->get_doorbell_button(1);
          ESP_LOGD("TAG", "Primary Action: %x", button.primary_action);
          ESP_LOGD("TAG", "Primary Payload: %x", button.primary_payload);
          ESP_LOGD("TAG", "Secondary Action: %x", button.secondary_action);
          ESP_LOGD("TAG", "Secondary Payload: %x", button.secondary_payload);