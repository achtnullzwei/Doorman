substitutions:
  rx_pin: GPIO9
  tx_pin: GPIO8
  led_pin: GPIO1
  rgb_led_pin: GPIO2
  relay_pin: GPIO42
  external_button_pin: GPIO41
  adc_input_pin: GPIO10
  name: doorman-s3
  friendly_name: Doorman S3
  log_level: VERBOSE
  update_url_stable: https://doorman.azon.ai/firmware/release/esp32-s3-quad.custom.nuki-bridge/manifest.json
  update_url_dev: https://dev.doorman.azon.ai/firmware/release/esp32-s3-quad.custom.nuki-bridge/manifest.json
  branch: dev
  firmware_type: nuki-bridge
  api_variant: custom
  host_platform: esp32-s3-quad
esphome:
  platformio_options:
    board_build.flash_mode: dio
  name: doorman-s3
  friendly_name: Doorman S3
  name_add_mac_suffix: false
  min_version: 2025.5.0
  project:
    name: AzonInc.Doorman-Nuki-Bridge
    version: 2025.6.0
  on_boot:
    - priority: 600.0
      then:
        - lock.template.publish:
            id: entrance_door
            state: LOCKED
        - lock.template.publish:
            id: second_entrance_door
            state: LOCKED
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return id(door_opener_mode).state == "Internal Relay";
            then:
              - switch.turn_off:
                  id: doorman_relay
        - event.trigger:
            id: entrance_doorbell_pattern
            event_type: default
        - event.trigger:
            id: second_entrance_doorbell_pattern
            event_type: default
        - event.trigger:
            id: apartment_doorbell_pattern
            event_type: default
        - event.trigger:
            id: phone_pick_up_pattern
            event_type: default
        - light.turn_on:
            id: doorman_rgb_status_led
            effect: pulse
            red: 1.0
            green: 0.65
            blue: 0.0
            state: true
        - wait_until:
            condition:
              wifi.connected: {}
        - light.turn_on:
            id: doorman_rgb_status_led
            effect: none
            red: 1.0
            green: 0.65
            blue: 0.0
            brightness: !lambda |-
              return id(doorman_rgb_status_led_brightness).state / 100.0;
            state: true
        - delay: 3s
        - script.execute:
            id: update_led
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return id(serial_number).state != 0 && id(intercom_model).state != "None";
            then:
              - tc_bus.read_memory:
                  serial_number: 0x00
  build_path: build\doorman-s3
  includes: []
  libraries: []
  debug_scheduler: false
  areas: []
  devices: []
esp32:
  board: esp32-s3-devkitc-1
  variant: ESP32S3
  flash_size: 8MB
  framework:
    version: 5.3.2
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: y
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: y
      CONFIG_ESP32S3_INSTRUCTION_CACHE_32KB: y
      CONFIG_SPIRAM_ALLOW_STACK_EXTERNAL_MEMORY: y
      CONFIG_SPIRAM_TRY_ALLOCATE_WIFI_LWIP: y
      CONFIG_BT_ALLOCATION_FROM_SPIRAM_FIRST: y
      CONFIG_BT_BLE_DYNAMIC_ENV_MEMORY: y
      CONFIG_SPIRAM_RODATA: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_MBEDTLS_EXTERNAL_MEM_ALLOC: y
      CONFIG_MBEDTLS_SSL_PROTO_TLS1_3: y
    advanced:
      compiler_optimization: SIZE
      enable_lwip_assert: true
      ignore_efuse_custom_mac: false
      enable_lwip_mdns_queries: true
      enable_lwip_bridge_interface: false
    components: []
    platform_version: https://github.com/pioarduino/platform-espressif32/releases/download/53.03.13/platform-espressif32.zip
    source: pioarduino/framework-espidf@https://github.com/pioarduino/esp-idf/releases/download/v5.3.2/esp-idf-v5.3.2.zip
    type: esp-idf
  cpu_frequency: 160MHZ
psram:
  mode: quad
  speed: 80MHZ
  enable_ecc: false
remote_receiver:
  - rmt_symbols: 192
    use_dma: false
    pin:
      number: 9
      mode:
        input: true
        pulldown: true
        output: false
        open_drain: false
        pullup: false
      inverted: false
      ignore_pin_validation_error: false
      ignore_strapping_warning: false
      drive_strength: 20.0
    filter: 1500us
    idle: 7000us
    dump:
      - raw: {}
    tolerance:
      value: 25
      type: percentage
    buffer_size: 10000
    receive_symbols: 192
remote_transmitter:
  - rmt_symbols: 48
    use_dma: false
    pin:
      number: 8
      mode:
        output: true
        input: false
        open_drain: false
        pullup: false
        pulldown: false
      inverted: false
      ignore_pin_validation_error: false
      ignore_strapping_warning: false
      drive_strength: 20.0
    carrier_duty_percent: 100
    eot_level: false
    on_complete:
      then:
        - if:
            condition:
              and:
                - switch.is_on:
                    id: doorman_status_led_bus_activity
            then:
              - script.execute:
                  id: blink_status_led
wifi:
  output_power: 8.5
  enable_btm: true
  enable_rrm: true
  ap:
    ssid: \033[5mDoorman S3 Setup\033[6m
    password: \033[5mOp3n-Sesame!\033[6m
    ap_timeout: 1min
  domain: .local
  reboot_timeout: 15min
  power_save_mode: LIGHT
  fast_connect: false
  passive_scan: false
  enable_on_boot: true
  networks:
    - ssid: \033[5mAZ-Wlan\033[6m
      password: \033[5m'152981435825046698'\033[6m
      priority: 0.0
  use_address: doorman-s3.local
external_components:
  - source:
      url: https://github.com/azoninc/doorman.git
      ref: dev
      type: git
    refresh: 60s
    components: all
  - source:
      url: https://github.com/uriyacovy/ESPHome_nuki_lock.git
      ref: esp-idf
      type: git
    refresh: 60s
    components: all
light:
  - platform: esp32_rmt_led_strip
    id: doorman_rgb_status_led
    icon: mdi:led-on
    name: RGB Status LED
    internal: true
    restore_mode: ALWAYS_OFF
    rgb_order: GRB
    pin: 2
    num_leds: 1
    chipset: WS2812
    use_psram: true
    rmt_symbols: 144
    gamma_correct: 1.0
    default_transition_length: 1s
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: -8.0
    effects:
      - lambda:
          name: pulse
          update_interval: 250ms
          lambda: !lambda |-
            static uint32_t transition_on_length_ = 250;
            static uint32_t transition_off_length_ = 250;
            static bool on_ = false;

            auto call = id(doorman_rgb_status_led).turn_on();

            float out = on_ ? (id(doorman_rgb_status_led_brightness).state / 100.0) : 0;
            call.set_brightness_if_supported(out);

            call.set_transition_length_if_supported(on_ ? transition_on_length_ : transition_off_length_);
            on_ = !on_;

            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();
      - lambda:
          name: slow_pulse
          update_interval: 2s
          lambda: !lambda |-
            static uint32_t transition_on_length_ = 2500;
            static uint32_t transition_off_length_ = 2500;
            static bool on_ = false;

            auto call = id(doorman_rgb_status_led).turn_on();

            float out = on_ ? (id(doorman_rgb_status_led_brightness).state / 100.0) : 0;
            call.set_brightness_if_supported(out);

            call.set_transition_length_if_supported(on_ ? transition_on_length_ : transition_off_length_);
            on_ = !on_;

            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();
      - lambda:
          name: slow_partymode
          update_interval: 2s
          lambda: !lambda |-
            static uint32_t transition_on_length_ = 4000;
            static uint32_t transition_off_length_ = 4000;
            static bool on_ = false;

            auto call = id(doorman_rgb_status_led).turn_on();

            float out = on_ ? (id(doorman_rgb_status_led_brightness).state / 100.0) : 0;
            call.set_brightness_if_supported(out);

            call.set_transition_length_if_supported(on_ ? transition_on_length_ : transition_off_length_);
            on_ = !on_;

            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();
      - lambda:
          name: error_api
          update_interval: 1s
          lambda: !lambda |-
            static bool state = false;

            auto call = id(doorman_rgb_status_led).turn_on();

            // Transition of 1000ms = 1s
            call.set_transition_length(1000);

            // Red / Blue
            if (state == 0) {
              call.set_rgb(1.0, 0, 0);
            } else {
              call.set_rgb(0, 0.22, 1.0);
            }

            call.set_brightness_if_supported(id(doorman_rgb_status_led_brightness).state / 100.0);

            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();

            state = !state;
    disabled_by_default: false
    flash_transition_length: 0s
    is_rgbw: false
    is_wrgb: false
    reset_high: 0us
    reset_low: 0us
  - platform: status_led
    id: doorman_status_led
    name: Status LED
    icon: mdi:led-on
    pin:
      number: 1
      mode:
        output: true
        input: false
        open_drain: false
        pullup: false
        pulldown: false
      inverted: false
      ignore_pin_validation_error: false
      ignore_strapping_warning: false
      drive_strength: 20.0
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: -9.0
    disabled_by_default: false
  - platform: binary
    id: hallway_light
    name: Hallway Light
    icon: mdi:lightbulb-on
    output: hallway_light_output
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 4.0
    restore_mode: ALWAYS_OFF
logger:
  id: esphome_logger
  level: VERBOSE
  initial_level: DEBUG
  baud_rate: 115200
  tx_buffer_size: 512
  deassert_rts_dtr: false
  task_log_buffer_size: 768
  hardware_uart: USB_SERIAL_JTAG
  logs: {}
web_server:
  version: 3
  sorting_groups:
    - id: sorting_group_controls
      name: Quick Actions
      sorting_weight: -100.0
    - id: sorting_group_settings
      name: Settings - General
      sorting_weight: -91.0
    - id: sorting_group_settings_advanced
      name: Settings - Advanced
      sorting_weight: -90.0
    - id: sorting_group_rto_settings
      name: Settings - Ring To Open
      sorting_weight: -80.0
    - id: sorting_group_intercom_settings
      name: Settings - TC:BUS Indoor Station
      sorting_weight: -70.0
    - id: sorting_group_nuki_settings
      name: Settings - Nuki Lock
      sorting_weight: -61.0
    - id: sorting_group_nuki_bridge_settings
      name: Settings - Nuki Bridge
      sorting_weight: -60.0
    - id: sorting_group_system
      name: Settings - System
      sorting_weight: -50.0
    - id: sorting_group_listeners
      name: Doorman Listeners
      sorting_weight: -40.0
    - id: sorting_group_debug_tools
      name: Debugging Tools
      sorting_weight: -30.0
    - id: sorting_group_updates
      name: Firmware Updates
      sorting_weight: -20.0
    - id: sorting_group_nuki
      name: Information - Nuki Lock
      sorting_weight: -10.0
    - id: sorting_group_information
      name: Information - System
      sorting_weight: -5.0
  port: 80
  enable_private_network_access: true
  include_internal: false
  ota: false
  log: true
  css_url: ''
  js_url: https://oi.esphome.io/v3/www.js
captive_portal: {}
improv_serial: {}
tc_bus:
  id: tc_bus_intercom
  event: doorman
  on_telegram:
    - then:
        - if:
            condition:
              and:
                - switch.is_on:
                    id: doorman_status_led_bus_activity
            then:
              - script.execute:
                  id: blink_status_led
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return x.type == TELEGRAM_TYPE_FOUND_DEVICE && id(search_mode) != 0;
            then:
              - lambda: !lambda |-
                  int mode = id(search_mode);
                  int serial = x.serial_number;

                  if (mode == 1) {
                    if (std::find(id(as_list).begin(), id(as_list).end(), serial) == id(as_list).end()) {
                      id(as_list).push_back(serial);
                    }
                  } else if (mode == 2) {
                    if (std::find(id(is0_list).begin(), id(is0_list).end(), serial) == id(is0_list).end()) {
                      id(is0_list).push_back(serial);
                    }
                  } else if (mode == 3) {
                    if (std::find(id(is1_list).begin(), id(is1_list).end(), serial) == id(is1_list).end()) {
                      id(is1_list).push_back(serial);
                    }
                  } else if (mode == 4) {
                    if (std::find(id(extra_list).begin(), id(extra_list).end(), serial) == id(extra_list).end()) {
                      id(extra_list).push_back(serial);
                    }
                  } else if (mode == 5) {
                    if (std::find(id(controller_list).begin(), id(controller_list).end(), serial) == id(controller_list).end()) {
                      id(controller_list).push_back(serial);
                    }
                  }
        - if:
            condition:
              and:
                - switch.is_on:
                    id: doorman_setup_mode
                - lambda: !lambda |-
                    return x.type == TELEGRAM_TYPE_FLOOR_CALL || x.type == TELEGRAM_TYPE_DOOR_CALL;
            then:
              - number.set:
                  id: serial_number
                  value: !lambda |-
                    return x.serial_number;
              - number.set:
                  id: entrance_door_station_id
                  value: !lambda |-
                    return x.address;
              - delay: 3s
              - logger.log:
                  format: 'Setup Step 2: Identifying Indoor Station.'
                  tag: main
                  level: DEBUG
                  args: []
              - tc_bus.identify:
                  serial_number: 0x00
                  device_group: 0
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return id(second_entrance_door_station_id).state == 63 && (x.type == TELEGRAM_TYPE_DOOR_CALL || x.type == TELEGRAM_TYPE_OPEN_DOOR) && x.address != id(entrance_door_station_id).state;
            then:
              - number.set:
                  id: second_entrance_door_station_id
                  value: !lambda |-
                    return x.address;
  on_read_memory_complete:
    - then:
        - lambda: !lambda |-
            std::string hexString = str_upper_case(format_hex(x));
            ESP_LOGI("tcs_bus", "Memory reading completed. Data: %s", hexString.c_str());
  on_read_memory_timeout:
    - then:
        - logger.log:
            format: Memory reading timed out! No memory block received in time.
            level: ERROR
            tag: main
            args: []
  on_identify_complete:
    - then:
        - logger.log:
            format: 'Identified Hardware: %s (v%i) | Firmware: %i.%i.%i'
            args:
              - !lambda |-
                model_to_string(x.model)
              - !lambda |-
                x.hardware_version
              - !lambda |-
                x.firmware_major
              - !lambda |-
                x.firmware_minor
              - !lambda |-
                x.firmware_patch
            level: INFO
            tag: main
        - delay: 2s
        - tc_bus.read_memory:
            serial_number: 0x00
        - if:
            condition:
              and:
                - switch.is_on:
                    id: doorman_setup_mode
            then:
              - script.execute:
                  id: complete_setup
  on_identify_timeout:
    - then:
        - logger.log:
            format: Failed to identify the Indoor Station. Please select it manually.
            level: ERROR
            tag: main
            args: []
        - if:
            condition:
              and:
                - switch.is_on:
                    id: doorman_setup_mode
            then:
              - script.execute:
                  id: complete_setup
  on_identify_unknown:
    - then:
        - if:
            condition:
              and:
                - switch.is_on:
                    id: doorman_setup_mode
            then:
              - logger.log:
                  format: Unknown model detected! Please open an issue and provide
                    your logs in order to implement support for this model.
                  level: WARN
                  tag: main
                  args: []
              - script.execute:
                  id: complete_setup
number:
  - platform: template
    id: doorman_rgb_status_led_brightness
    name: 'Status LED: Brightness'
    mode: SLIDER
    icon: mdi:brightness-7
    restore_value: true
    initial_value: 100.0
    max_value: 100.0
    min_value: 10.0
    step: 1.0
    optimistic: true
    disabled_by_default: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -39.0
    update_interval: 60s
  - platform: tc_bus
    serial_number:
      id: serial_number
      name: Serial Number
      icon: mdi:numeric
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_settings
        sorting_weight: -100.0
      entity_category: config
      mode: BOX
  - platform: template
    id: entrance_door_station_id
    name: Entrance Door Station ID
    mode: BOX
    icon: mdi:counter
    restore_value: true
    initial_value: 0.0
    max_value: 63.0
    min_value: 0.0
    step: 1.0
    optimistic: true
    disabled_by_default: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings
      sorting_weight: -99.0
    update_interval: 60s
  - platform: template
    id: second_entrance_door_station_id
    name: Second Entrance Door Station ID
    mode: BOX
    icon: mdi:counter
    restore_value: true
    initial_value: 63.0
    max_value: 63.0
    min_value: 0.0
    step: 1.0
    optimistic: true
    disabled_by_default: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings
      sorting_weight: -98.0
    update_interval: 60s
  - platform: tc_bus
    volume_ringtone:
      id: intercom_volume_ringtone
      name: 'Volume: Ringtone'
      icon: mdi:volume-high
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_intercom_settings
        sorting_weight: -70.0
      mode: AUTO
    volume_handset_door_call:
      id: intercom_volume_handset_door_call
      name: 'Volume: Handset Door Call'
      icon: mdi:volume-high
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_intercom_settings
        sorting_weight: -69.0
      mode: AUTO
    volume_handset_internal_call:
      id: intercom_volume_handset_internal_call
      name: 'Volume: Handset Internal Call'
      icon: mdi:volume-high
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_intercom_settings
        sorting_weight: -68.0
      mode: AUTO
  - platform: template
    id: nuki_security_pin
    name: Nuki Security Pin
    icon: mdi:shield-key
    disabled_by_default: true
    mode: BOX
    step: 1.0
    min_value: 0.0
    max_value: 65535.0
    set_action:
      then:
        - nuki_lock.set_security_pin:
            security_pin: !lambda |-
              return x;
    web_server:
      sorting_group_id: sorting_group_nuki_bridge_settings
      sorting_weight: -31.0
    optimistic: false
    update_interval: 60s
    initial_value: 0.0
text:
  - platform: template
    id: entrance_door_before_open_cmds
    name: Entrance Door Pre-Open-Telegrams
    icon: mdi:link-lock
    optimistic: true
    min_length: 0
    max_length: 255
    mode: TEXT
    restore_value: true
    initial_value: ''
    disabled_by_default: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -70.0
    update_interval: 60s
  - platform: template
    id: second_entrance_door_before_open_cmds
    name: Second Entrance Door Pre-Open-Telegrams
    icon: mdi:link-lock
    optimistic: true
    min_length: 0
    max_length: 255
    mode: TEXT
    restore_value: true
    initial_value: ''
    disabled_by_default: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -69.0
    update_interval: 60s
  - platform: template
    id: debug_send_telegram
    name: Send Telegram
    icon: mdi:send
    mode: TEXT
    disabled_by_default: true
    optimistic: true
    set_action:
      then:
        - lambda: !lambda |-
            x.erase(std::remove_if(x.begin(), x.end(), [](char c) { return !std::isxdigit(c); }), x.end());
            x.erase(0, x.find_first_not_of('0'));
            x.resize(8);
            unsigned long number = 0;
            if(std::string(x.c_str()) != "") {
              number = std::stoul(x.c_str(), nullptr, 16);
            }
            id(tc_bus_intercom)->send_telegram(number);
    web_server:
      sorting_group_id: sorting_group_debug_tools
    min_length: 0
    max_length: 255
    restore_value: false
    update_interval: 60s
    initial_value: ''
text_sensor:
  - platform: tc_bus
    hardware_version:
      id: doorman_hardware_version
      name: Doorman Hardware
      icon: mdi:router-wireless
      disabled_by_default: true
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_group_information
        sorting_weight: -20.0
    bus_telegram:
      id: last_bus_telegram
      name: Last Bus Telegram
      web_server:
        sorting_group_id: sorting_group_listeners
        sorting_weight: -99.0
      disabled_by_default: false
      icon: mdi:console-network
      entity_category: diagnostic
  - platform: version
    id: esphome_version
    name: ESPHome Version
    icon: mdi:information-box
    hide_timestamp: true
    entity_category: diagnostic
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_updates
      sorting_weight: 0.0
  - platform: template
    id: doorman_firmware_version
    name: Doorman Firmware Version
    icon: mdi:information-box
    lambda: !lambda |-
      return { ESPHOME_PROJECT_VERSION };
    entity_category: diagnostic
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_updates
      sorting_weight: 1.0
    update_interval: 60s
  - platform: debug
    reset_reason:
      name: Reset Reason
      id: debug_restart_reason
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_group_debug_tools
      disabled_by_default: false
      icon: mdi:restart
switch:
  - platform: tc_bus
    force_long_door_opener:
      id: use_32_open_door_protocol
      name: Use 32-Bit Door Protocol
      icon: mdi:flash-alert
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_settings_advanced
        sorting_weight: -50.0
      restore_mode: ALWAYS_OFF
      device_class: switch
  - platform: gpio
    name: Relay
    icon: mdi:electric-switch
    id: doorman_relay
    restore_mode: RESTORE_DEFAULT_OFF
    disabled_by_default: true
    pin:
      number: 42
      mode:
        output: true
        input: false
        open_drain: false
        pullup: false
        pulldown: false
      inverted: false
      ignore_pin_validation_error: false
      ignore_strapping_warning: false
      drive_strength: 20.0
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 6.0
    interlock_wait_time: 0ms
  - platform: template
    id: doorman_status_led_bus_activity
    name: 'Status LED: Show Bus Activity'
    icon: mdi:swap-vertical
    restore_mode: RESTORE_DEFAULT_OFF
    disabled_by_default: true
    optimistic: true
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -40.0
    assumed_state: false
  - platform: template
    id: dev_firmware
    name: Experimental Firmware
    icon: mdi:test-tube
    entity_category: config
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - then:
          - logger.log:
              format: OTA update source set to dev
              tag: main
              level: DEBUG
              args: []
          - lambda: !lambda |-
              id(update_http_request).set_source_url(to_string("https://dev.doorman.azon.ai/firmware/release/esp32-s3-quad.custom.nuki-bridge/manifest.json"));
          - component.update:
              id: update_http_request
    on_turn_off:
      - then:
          - logger.log:
              format: OTA update source set to master
              tag: main
              level: DEBUG
              args: []
          - lambda: !lambda |-
              id(update_http_request).set_source_url(to_string("https://doorman.azon.ai/firmware/release/esp32-s3-quad.custom.nuki-bridge/manifest.json"));
          - component.update:
              id: update_http_request
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_updates
      sorting_weight: 98.0
    setup_priority: -120.0
    assumed_state: false
  - platform: template
    id: rto_central
    name: Ring To Open
    icon: mdi:checkbox-marked-circle-auto-outline
    restore_mode: RESTORE_DEFAULT_OFF
    lambda: !lambda |-
      if(id(rto_central_doors).state == "Entrance") {
        return id(rto_entrance_door).state;
      } else if(id(rto_central_doors).state == "Second Entrance") {
        return id(rto_second_entrance_door).state;
      } else if(id(rto_central_doors).state == "Any Entrance") {
        return id(rto_entrance_door).state || id(rto_second_entrance_door).state;
      } else if(id(rto_central_doors).state == "Apartment") {
        return id(rto_apartment_door).state;
      } else if(id(rto_central_doors).state == "Any Entrance & Apartment") {
        return id(rto_entrance_door).state || id(rto_second_entrance_door).state || id(rto_apartment_door).state;
      }
      return false;
    turn_on_action:
      then:
        - lambda: !lambda |-
            if(id(rto_central_doors).state == "Entrance") {
              id(rto_entrance_door).turn_on();
            } else if(id(rto_central_doors).state == "Second Entrance") {
              id(rto_second_entrance_door).turn_on();
            } else if(id(rto_central_doors).state == "Any Entrance") {
              id(rto_entrance_door).turn_on();
              id(rto_second_entrance_door).turn_on();
            } else if(id(rto_central_doors).state == "Apartment") {
              id(rto_apartment_door).turn_on();
            } else if(id(rto_central_doors).state == "Any Entrance & Apartment") {
              id(rto_entrance_door).turn_on();
              id(rto_second_entrance_door).turn_on();
              id(rto_apartment_door).turn_on();
            }
    turn_off_action:
      then:
        - lambda: !lambda |-
            if(id(rto_central_doors).state == "Entrance") {
              id(rto_entrance_door).turn_off();
            } else if(id(rto_central_doors).state == "Second Entrance") {
              id(rto_second_entrance_door).turn_off();
            } else if(id(rto_central_doors).state == "Any Entrance") {
              id(rto_entrance_door).turn_off();
              id(rto_second_entrance_door).turn_off();
            } else if(id(rto_central_doors).state == "Apartment") {
              id(rto_apartment_door).turn_off();
            } else if(id(rto_central_doors).state == "Any Entrance & Apartment") {
              id(rto_entrance_door).turn_off();
              id(rto_second_entrance_door).turn_off();
              id(rto_apartment_door).turn_off();
            }
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 5.0
    disabled_by_default: false
    optimistic: false
    assumed_state: false
  - platform: template
    id: rto_entrance_door
    name: 'RTO: Entrance Door'
    icon: mdi:checkbox-marked-circle-auto-outline
    restore_mode: RESTORE_DEFAULT_OFF
    disabled_by_default: true
    optimistic: true
    turn_on_action:
      then:
        - script.execute:
            id: rto_entrance_door_timer
    turn_off_action:
      then:
        - script.stop:
            id: rto_entrance_door_timer
    on_turn_on:
      - then:
          - script.execute:
              id: update_led
    on_turn_off:
      - then:
          - script.execute:
              id: update_led
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -80.0
    assumed_state: false
  - platform: template
    id: rto_second_entrance_door
    name: 'RTO: Second Entrance Door'
    icon: mdi:checkbox-marked-circle-auto-outline
    restore_mode: RESTORE_DEFAULT_OFF
    disabled_by_default: true
    optimistic: true
    turn_on_action:
      then:
        - script.execute:
            id: rto_second_entrance_door_timer
    turn_off_action:
      then:
        - script.stop:
            id: rto_second_entrance_door_timer
    on_turn_on:
      - then:
          - script.execute:
              id: update_led
    on_turn_off:
      - then:
          - script.execute:
              id: update_led
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -70.0
    assumed_state: false
  - platform: template
    id: rto_apartment_door
    name: 'RTO: Apartment Door'
    disabled_by_default: true
    internal: false
    icon: mdi:checkbox-marked-circle-auto-outline
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    turn_on_action:
      then:
        - script.execute:
            id: rto_apartment_door_timer
    turn_off_action:
      then:
        - script.stop:
            id: rto_apartment_door_timer
    on_turn_on:
      - then:
          - script.execute:
              id: update_led
    on_turn_off:
      - then:
          - script.execute:
              id: update_led
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -50.0
    assumed_state: false
  - platform: template
    id: rto_confirmation
    name: 'RTO: Confirmation'
    icon: mdi:bell-check
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    entity_category: config
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -100.0
    assumed_state: false
  - platform: template
    id: rto_led_status
    name: 'RTO: Display Status'
    icon: mdi:led-on
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: config
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -99.0
    assumed_state: false
  - platform: template
    name: Setup Mode
    icon: mdi:account-cog
    id: doorman_setup_mode
    restore_mode: RESTORE_DEFAULT_ON
    entity_category: config
    optimistic: true
    on_turn_on:
      - then:
          - logger.log:
              format: 'Setup Step 1: Waiting for door or floor call.'
              tag: main
              level: DEBUG
              args: []
          - script.execute:
              id: update_led
    on_turn_off:
      - then:
          - script.execute:
              id: update_led
    web_server:
      sorting_group_id: sorting_group_settings
      sorting_weight: 100.0
    disabled_by_default: false
    assumed_state: false
button:
  - platform: restart
    id: doorman_restart
    entity_category: config
    name: Restart
    icon: mdi:restart
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: -2.0
    device_class: restart
  - platform: factory_reset
    id: doorman_factory_reset
    name: Restore Factory Settings
    entity_category: config
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: 0.0
    icon: mdi:restart-alert
    device_class: restart
  - platform: safe_mode
    id: doorman_safe_mode
    name: Safe mode
    entity_category: config
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: -1.0
    icon: mdi:restart-alert
    device_class: restart
  - platform: template
    id: update_install
    name: Install Update
    icon: mdi:auto-fix
    on_press:
      - then:
          - if:
              condition:
                and:
                  - update.is_available:
                      id: update_http_request
              then:
                - update.perform:
                    id: update_http_request
                    force_update: false
              else:
                - logger.log:
                    format: No update available
                    tag: main
                    level: DEBUG
                    args: []
    web_server:
      sorting_group_id: sorting_group_updates
      sorting_weight: 100.0
    disabled_by_default: false
  - platform: template
    id: debug_restart_control_unit
    name: System Restart
    icon: mdi:restart
    disabled_by_default: true
    on_press:
      - then:
          - tc_bus.send:
              type: reset
              address: 0x00
              payload: 0x00
              serial_number: 0x00
    web_server:
      sorting_group_id: sorting_group_debug_tools
  - platform: template
    id: debug_system_discovery
    name: System Discovery
    icon: mdi:home-search
    disabled_by_default: true
    on_press:
      - then:
          - logger.log:
              format: Start system discovery...
              tag: main
              level: DEBUG
              args: []
          - lambda: !lambda |-
              id(as_list).clear();
              id(is0_list).clear();
              id(is1_list).clear();
              id(extra_list).clear();
              id(controller_list).clear();
          - light.turn_on:
              id: doorman_rgb_status_led
              red: 1.0
              green: 0.45
              blue: 0.83
              effect: pulse
              state: true
          - logger.log:
              format: Search outdoor stations (2)...
              tag: main
              level: DEBUG
              args: []
          - tc_bus.send:
              type: select_device_group
              payload: 0x02
              address: 0x00
              serial_number: 0x00
          - globals.set:
              id: search_mode
              value: '1'
          - delay: 350ms
          - tc_bus.send:
              type: search_devices
              address: 0x00
              payload: 0x00
              serial_number: 0x00
          - delay: 5s
          - logger.log:
              format: Search indoor stations (0)...
              tag: main
              level: DEBUG
              args: []
          - globals.set:
              id: search_mode
              value: '2'
          - tc_bus.send:
              type: select_device_group
              payload: 0x00
              address: 0x00
              serial_number: 0x00
          - delay: 350ms
          - tc_bus.send:
              type: search_devices
              address: 0x00
              payload: 0x00
              serial_number: 0x00
          - delay: 10s
          - logger.log:
              format: Search indoor stations (1)...
              tag: main
              level: DEBUG
              args: []
          - globals.set:
              id: search_mode
              value: '3'
          - tc_bus.send:
              type: select_device_group
              payload: 0x01
              address: 0x00
              serial_number: 0x00
          - delay: 350ms
          - tc_bus.send:
              type: search_devices
              address: 0x00
              payload: 0x00
              serial_number: 0x00
          - delay: 10s
          - logger.log:
              format: Search extras (6)...
              tag: main
              level: DEBUG
              args: []
          - globals.set:
              id: search_mode
              value: '4'
          - tc_bus.send:
              type: select_device_group
              payload: 0x06
              address: 0x00
              serial_number: 0x00
          - delay: 350ms
          - tc_bus.send:
              type: search_devices
              address: 0x00
              payload: 0x00
              serial_number: 0x00
          - delay: 10s
          - logger.log:
              format: Search controllers (4)...
              tag: main
              level: DEBUG
              args: []
          - globals.set:
              id: search_mode
              value: '5'
          - tc_bus.send:
              type: select_device_group
              payload: 0x04
              address: 0x00
              serial_number: 0x00
          - delay: 350ms
          - tc_bus.send:
              type: search_devices
              address: 0x00
              payload: 0x00
              serial_number: 0x00
          - delay: 10s
          - globals.set:
              id: search_mode
              value: '0'
          - logger.log:
              format: Search complete!
              tag: main
              level: DEBUG
              args: []
          - lambda: !lambda |-
              ESP_LOGI("DEBUG", "Controllers (Group 4): %d", id(controller_list).size());
              if(id(controller_list).size() > 0) {
                for (const auto& value : id(controller_list)) {
                  ESP_LOGI("DEBUG", "%d", value);
                }
              } else {
                ESP_LOGI("DEBUG", "No results!");
              }
              ESP_LOGI("DEBUG", "    ");
          - lambda: !lambda |-
              ESP_LOGI("DEBUG", "Outdoor Stations (Group 2): %d", id(as_list).size());
              if(id(as_list).size() > 0) {
                for (const auto& value : id(as_list)) {
                  ESP_LOGI("DEBUG", "%d", value);
                }
              } else {
                ESP_LOGI("DEBUG", "No results!");
              }
              ESP_LOGI("DEBUG", "    ");
          - lambda: !lambda |-
              ESP_LOGI("DEBUG", "Indoor Stations (Group 0): %d", id(is0_list).size());
              if(id(is0_list).size() > 0) {
                for (const auto& value : id(is0_list)) {
                  ESP_LOGI("DEBUG", "%d", value);
                }
              } else {
                ESP_LOGI("DEBUG", "No results!");
              }
              ESP_LOGI("DEBUG", "    ");
          - lambda: !lambda |-
              ESP_LOGI("DEBUG", "Indoor Stations (Group 1): %d", id(is1_list).size());
              if(id(is1_list).size() > 0) {
                for (const auto& value : id(is1_list)) {
                  ESP_LOGI("DEBUG", "%d", value);
                }
              } else {
                ESP_LOGI("DEBUG", "No results!");
              }
              ESP_LOGI("DEBUG", "    ");
          - lambda: !lambda |-
              ESP_LOGI("DEBUG", "Extras (Group 6): %d", id(extra_list).size());
              if(id(extra_list).size() > 0) {
                for (const auto& value : id(extra_list)) {
                  ESP_LOGI("DEBUG", "%d", value);
                }
              } else {
                ESP_LOGI("DEBUG", "No results!");
              }
          - light.turn_on:
              id: doorman_rgb_status_led
              red: 1.0
              green: 0.45
              blue: 0.83
              effect: none
              brightness: !lambda |-
                return id(doorman_rgb_status_led_brightness).state / 100.0;
              state: true
          - delay: 3s
          - script.execute:
              id: update_led
    web_server:
      sorting_group_id: sorting_group_debug_tools
  - platform: template
    id: read_memory
    name: Read Memory
    icon: mdi:file-arrow-up-down
    on_press:
      - then:
          - tc_bus.read_memory:
              serial_number: 0x00
    entity_category: config
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_intercom_settings
      sorting_weight: -95.0
  - platform: template
    id: identify_indoor_station
    name: Identify Indoor Station
    icon: mdi:identifier
    entity_category: config
    disabled_by_default: true
    on_press:
      - then:
          - tc_bus.identify:
              serial_number: 0x00
              device_group: 0
    web_server:
      sorting_group_id: sorting_group_settings
      sorting_weight: -96.0
output:
  - platform: template
    id: hallway_light_output
    write_action:
      then:
        - if:
            condition:
              lambda: !lambda |-
                return state;
            then:
              - tc_bus.send:
                  type: light
                  address: 0x00
                  payload: 0x00
                  serial_number: 0x00
              - delay: 5s
              - light.turn_off:
                  id: hallway_light
                  state: false
    type: binary
sensor:
  - platform: uptime
    name: Uptime
    id: doorman_uptime
    disabled_by_default: true
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_information
      sorting_weight: -7.0
    force_update: false
    unit_of_measurement: s
    icon: mdi:timer-outline
    accuracy_decimals: 0
    device_class: duration
    state_class: total_increasing
    update_interval: 60s
    type: seconds
  - platform: wifi_signal
    id: doorman_wifi_signal_db
    update_interval: 60s
    internal: true
    disabled_by_default: false
    force_update: false
    unit_of_measurement: dBm
    accuracy_decimals: 0
    device_class: signal_strength
    state_class: measurement
    entity_category: diagnostic
    name: doorman_wifi_signal_db
  - platform: copy
    id: doorman_wifi_signal
    icon: mdi:wifi
    source_id: doorman_wifi_signal_db
    name: WiFi Signal
    filters:
      - lambda: !lambda |-
          return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: '%'
    entity_category: diagnostic
    disabled_by_default: true
    device_class: ''
    web_server:
      sorting_group_id: sorting_group_information
      sorting_weight: -5.0
    force_update: false
    accuracy_decimals: 0
    state_class: measurement
  - platform: adc
    id: debug_bus_voltage
    name: Bus Voltage
    pin:
      number: 10
      mode:
        input: true
        output: false
        open_drain: false
        pullup: false
        pulldown: false
      inverted: false
      ignore_pin_validation_error: false
      ignore_strapping_warning: false
      drive_strength: 20.0
    update_interval: 5s
    attenuation: 12db
    entity_category: diagnostic
    disabled_by_default: true
    icon: mdi:current-dc
    web_server:
      sorting_group_id: sorting_group_debug_tools
      sorting_weight: -5.0
    force_update: false
    unit_of_measurement: V
    accuracy_decimals: 2
    device_class: voltage
    state_class: measurement
    raw: false
    samples: 1
    sampling_mode: avg
  - platform: debug
    free:
      id: debug_heap_free
      name: Heap Free
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_group_debug_tools
      disabled_by_default: false
      force_update: false
      unit_of_measurement: B
      icon: mdi:counter
      accuracy_decimals: 0
    block:
      id: debug_heap_max_block
      name: Heap Max Block
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_group_debug_tools
      disabled_by_default: false
      force_update: false
      unit_of_measurement: B
      icon: mdi:counter
      accuracy_decimals: 0
  - platform: debug
    psram:
      id: debug_free_psram
      name: Free PSRAM
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_group_debug_tools
      disabled_by_default: false
      force_update: false
      unit_of_measurement: B
      icon: mdi:counter
      accuracy_decimals: 0
binary_sensor:
  - platform: gpio
    pin:
      number: 0
      inverted: true
      mode:
        input: true
        pullup: true
        output: false
        open_drain: false
        pulldown: false
      ignore_strapping_warning: true
      ignore_pin_validation_error: false
      drive_strength: 20.0
    internal: false
    id: doorman_boot_button
    name: Flash Button
    icon: mdi:gesture-tap
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: 100.0
    on_multi_click:
      - timing:
          - state: true
            min_length: 5s
        then:
          - if:
              condition:
                binary_sensor.is_on:
                  id: nuki_paired
              then:
                - nuki_lock.unpair:
                    id: apartment_door
                - lambda: !lambda |
                    ESP_LOGI("pairing", "Pairing Mode: TODO");
          - nuki_lock.set_pairing_mode:
              id: apartment_door
              pairing_mode: true
        invalid_cooldown: 1s
    use_interrupt: true
    interrupt_type: ANY
  - platform: gpio
    id: doorman_external_button
    name: External Button
    icon: mdi:gesture-tap
    disabled_by_default: true
    pin:
      number: 41
      mode:
        pullup: true
        input: true
        output: false
        open_drain: false
        pulldown: false
      inverted: true
      ignore_pin_validation_error: false
      ignore_strapping_warning: false
      drive_strength: 20.0
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: 99.0
    on_press:
      - then:
          - if:
              condition:
                and:
                  - lambda: !lambda |-
                      return id(rto_toggle_trigger).state == "External Button";
              then:
                - switch.toggle:
                    id: rto_central
                - delay: 300ms
                - if:
                    condition:
                      and:
                        - switch.is_on:
                            id: rto_central
                        - switch.is_on:
                            id: rto_confirmation
                    then:
                      - tc_bus.send:
                          type: floor_call
                          address: 0x00
                          payload: 0x00
                          serial_number: 0x00
                - tc_bus.send:
                    type: reset
                    address: 0x00
                    payload: 0x00
                    serial_number: 0x00
    use_interrupt: true
    interrupt_type: ANY
  - platform: tc_bus
    id: entrance_doorbell
    name: Entrance Doorbell
    type: door_call
    address_lambda: !lambda |-
      return id(entrance_door_station_id).state;
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -28.0
    on_multi_click:
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1800ms
        trigger_id: edb_pattern_single
        then:
          - event.trigger:
              id: entrance_doorbell_pattern
              event_type: single
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1700ms
        trigger_id: edb_pattern_double
        then:
          - lambda: !lambda |-
              id(edb_pattern_single).cancel();
          - event.trigger:
              id: entrance_doorbell_pattern
              event_type: double
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1600ms
        trigger_id: edb_pattern_triple
        then:
          - lambda: !lambda |-
              id(edb_pattern_single).cancel();
          - event.trigger:
              id: entrance_doorbell_pattern
              event_type: triple
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1500ms
        trigger_id: edb_pattern_quadruple
        then:
          - lambda: !lambda |-
              id(edb_pattern_single).cancel();
          - event.trigger:
              id: entrance_doorbell_pattern
              event_type: quadruple
        invalid_cooldown: 1s
    on_press:
      - then:
          - if:
              condition:
                and:
                  - switch.is_on:
                      id: rto_entrance_door
                  - lambda: !lambda |-
                      return id(rto_entrance_door_pattern_condition).state == "single";
              then:
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_entrance_door_timeout_mode).state == "Ring once";
                    then:
                      - switch.turn_off:
                          id: rto_entrance_door
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_entrance_door_delay).state == "Random";
                    then:
                      - delay: !lambda |-
                          return 5000 + (rand() % 10000);
                    else:
                      - delay: !lambda |-
                          std::string str = id(rto_entrance_door_delay).state;
                          size_t pos = str.find(' ');
                          std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                          int value = std::stoi(first_token) * 1000;
                          if(value == 0)
                          {
                            value += 300; // Ensure at least 300ms delay
                          }
                          return value;
                - script.execute:
                    id: rto_entrance_door_action
    icon: mdi:doorbell
  - platform: tc_bus
    id: second_entrance_doorbell
    name: Second Entrance Doorbell
    type: door_call
    address_lambda: !lambda |-
      return id(second_entrance_door_station_id).state;
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -27.0
    on_multi_click:
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1800ms
        trigger_id: sedb_pattern_single
        then:
          - event.trigger:
              id: second_entrance_doorbell_pattern
              event_type: single
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1700ms
        trigger_id: sedb_pattern_double
        then:
          - lambda: !lambda |-
              id(sedb_pattern_single).cancel();
          - event.trigger:
              id: second_entrance_doorbell_pattern
              event_type: double
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1600ms
        trigger_id: sedb_pattern_triple
        then:
          - lambda: !lambda |-
              id(sedb_pattern_single).cancel();
          - event.trigger:
              id: second_entrance_doorbell_pattern
              event_type: triple
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1500ms
        trigger_id: sedb_pattern_quadruple
        then:
          - lambda: !lambda |-
              id(sedb_pattern_single).cancel();
          - event.trigger:
              id: second_entrance_doorbell_pattern
              event_type: quadruple
        invalid_cooldown: 1s
    on_press:
      - then:
          - if:
              condition:
                and:
                  - switch.is_on:
                      id: rto_second_entrance_door
                  - lambda: !lambda |-
                      return id(rto_second_entrance_door_pattern_condition).state == "single";
              then:
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_second_entrance_door_timeout_mode).state == "Ring once";
                    then:
                      - switch.turn_off:
                          id: rto_second_entrance_door
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_second_entrance_door_delay).state == "Random";
                    then:
                      - delay: !lambda |-
                          return 5000 + (rand() % 10000);
                    else:
                      - delay: !lambda |-
                          std::string str = id(rto_second_entrance_door_delay).state;
                          size_t pos = str.find(' ');
                          std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                          int value = std::stoi(first_token) * 1000;
                          if(value == 0)
                          {
                            value += 300; // Ensure at least 300ms delay
                          }
                          return value;
                - script.execute:
                    id: rto_second_entrance_door_action
    icon: mdi:doorbell
  - platform: tc_bus
    id: apartment_doorbell
    name: Apartment Doorbell
    type: floor_call
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -29.0
    on_multi_click:
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1800ms
        trigger_id: adb_pattern_single
        then:
          - event.trigger:
              id: apartment_doorbell_pattern
              event_type: single
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1700ms
        trigger_id: adb_pattern_double
        then:
          - lambda: !lambda |-
              id(adb_pattern_single).cancel();
          - event.trigger:
              id: apartment_doorbell_pattern
              event_type: double
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1600ms
        trigger_id: adb_pattern_triple
        then:
          - lambda: !lambda |-
              id(adb_pattern_single).cancel();
          - event.trigger:
              id: apartment_doorbell_pattern
              event_type: triple
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1500ms
        trigger_id: adb_pattern_quadruple
        then:
          - lambda: !lambda |-
              id(adb_pattern_single).cancel();
          - event.trigger:
              id: apartment_doorbell_pattern
              event_type: quadruple
        invalid_cooldown: 1s
    on_press:
      - then:
          - if:
              condition:
                and:
                  - switch.is_on:
                      id: rto_apartment_door
                  - lambda: !lambda |-
                      return id(rto_apartment_door_pattern_condition).state == "single";
              then:
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_apartment_door_timeout_mode).state == "Ring once";
                    then:
                      - switch.turn_off:
                          id: rto_apartment_door
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_apartment_door_delay).state == "Random";
                    then:
                      - delay: !lambda |-
                          return 5000 + (rand() % 10000);
                    else:
                      - delay: !lambda |-
                          std::string str = id(rto_apartment_door_delay).state;
                          size_t pos = str.find(' ');
                          std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                          int value = std::stoi(first_token) * 1000;
                          return value;
                - script.execute:
                    id: rto_apartment_door_action
    icon: mdi:doorbell
  - platform: tc_bus
    id: pick_up_phone_door_call
    name: Pick up phone (door call)
    icon: mdi:phone-check
    type: start_talking_door_call
    address: 0xFF
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -19.0
  - platform: tc_bus
    id: hang_up_phone_door_call
    name: Hang up phone (door call)
    icon: mdi:phone-remove
    type: stop_talking_door_call
    address: 0xFF
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -18.0
  - platform: tc_bus
    id: pick_up_phone
    name: Pick up phone
    icon: mdi:phone-check
    type: start_talking
    address: 0xFF
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -17.0
    on_multi_click:
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1800ms
        trigger_id: ppu_pattern_single
        then:
          - event.trigger:
              id: phone_pick_up_pattern
              event_type: single
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1700ms
        trigger_id: ppu_pattern_double
        then:
          - lambda: !lambda |-
              id(ppu_pattern_single).cancel();
          - event.trigger:
              id: phone_pick_up_pattern
              event_type: double
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1600ms
        trigger_id: ppu_pattern_triple
        then:
          - lambda: !lambda |-
              id(ppu_pattern_single).cancel();
          - event.trigger:
              id: phone_pick_up_pattern
              event_type: triple
        invalid_cooldown: 1s
      - timing:
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 0ms
            max_length: 1s
          - state: true
            min_length: 0ms
            max_length: 500ms
          - state: false
            min_length: 1500ms
        trigger_id: ppu_pattern_quadruple
        then:
          - lambda: !lambda |-
              id(ppu_pattern_single).cancel();
          - event.trigger:
              id: phone_pick_up_pattern
              event_type: quadruple
        invalid_cooldown: 1s
  - platform: tc_bus
    id: hang_up_phone
    name: Hang up phone
    icon: mdi:phone-remove
    type: stop_talking
    address: 0xFF
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -16.0
  - platform: tc_bus
    id: function_button
    name: Function Button
    icon: mdi:circle-outline
    auto_off: 200ms
    type: control_function
    payload: 0xFF
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -6.0
    on_press:
      - then:
          - if:
              condition:
                and:
                  - lambda: !lambda |-
                      return id(rto_toggle_trigger).state == "Function Button";
              then:
                - switch.toggle:
                    id: rto_central
                - delay: 300ms
                - if:
                    condition:
                      and:
                        - switch.is_on:
                            id: rto_central
                        - switch.is_on:
                            id: rto_confirmation
                    then:
                      - tc_bus.send:
                          type: floor_call
                          address: 0x00
                          payload: 0x00
                          serial_number: 0x00
                - tc_bus.send:
                    type: reset
                    address: 0x00
                    payload: 0x00
                    serial_number: 0x00
  - platform: tc_bus
    id: light_button
    name: Light Button
    icon: mdi:white-balance-sunny
    type: light
    auto_off: 200ms
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -7.0
  - platform: tc_bus
    id: open_entrance_door_button
    internal: true
    type: open_door
    address_lambda: !lambda |-
      return id(entrance_door_station_id).state;
    serial_number: 0xFF
    auto_off: 5s
    on_press:
      - then:
          - lock.template.publish:
              id: entrance_door
              state: UNLOCKED
    on_release:
      - then:
          - lock.template.publish:
              id: entrance_door
              state: LOCKED
    disabled_by_default: false
    icon: mdi:doorbell
    name: Doorbell
  - platform: tc_bus
    id: open_second_entrance_door_button
    internal: true
    type: open_door
    address_lambda: !lambda |-
      return id(second_entrance_door_station_id).state;
    serial_number: 0xFF
    auto_off: 5s
    on_press:
      - then:
          - lock.template.publish:
              id: second_entrance_door
              state: UNLOCKED
    on_release:
      - then:
          - lock.template.publish:
              id: second_entrance_door
              state: LOCKED
    disabled_by_default: false
    icon: mdi:doorbell
    name: Doorbell
  - platform: template
    id: debug_bus_connected
    name: Bus Connection Status
    icon: mdi:connection
    disabled_by_default: true
    lambda: !lambda |-
      if (id(debug_bus_voltage).state >= 2.8) {
        return true;
      } else {
        return false;
      }
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_debug_tools
lock:
  - platform: template
    id: entrance_door
    name: Entrance Door
    icon: mdi:door
    lock_action:
      then:
        - lock.template.publish:
            id: entrance_door
            state: LOCKED
    unlock_action:
      then:
        - lock.template.publish:
            id: entrance_door
            state: UNLOCKED
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return id(door_opener_mode).state == "Bus Telegram";
            then:
              - script.execute:
                  id: send_telegram_chain
                  telegram_list: !lambda |-
                    return id(entrance_door_before_open_cmds).state;
              - tc_bus.send:
                  type: open_door
                  address: !lambda |-
                    return id(entrance_door_station_id).state;
                  payload: 0x00
                  serial_number: 0x00
            else:
              - switch.turn_on:
                  id: doorman_relay
        - delay: 5s
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return id(door_opener_mode).state == "Internal Relay";
            then:
              - switch.turn_off:
                  id: doorman_relay
        - lock.template.publish:
            id: entrance_door
            state: LOCKED
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 1.0
    disabled_by_default: false
    optimistic: false
    assumed_state: false
  - platform: template
    id: second_entrance_door
    name: Second Entrance Door
    icon: mdi:door
    disabled_by_default: true
    lock_action:
      then:
        - lock.template.publish:
            id: second_entrance_door
            state: LOCKED
    unlock_action:
      then:
        - lock.template.publish:
            id: second_entrance_door
            state: UNLOCKED
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return id(door_opener_mode).state == "Bus Telegram";
            then:
              - script.execute:
                  id: send_telegram_chain
                  telegram_list: !lambda |-
                    return id(second_entrance_door_before_open_cmds).state;
              - tc_bus.send:
                  type: open_door
                  address: !lambda |-
                    return id(second_entrance_door_station_id).state;
                  payload: 0x00
                  serial_number: 0x00
        - delay: 5s
        - if:
            condition:
              and:
                - lambda: !lambda |-
                    return id(door_opener_mode).state == "Internal Relay";
            then:
              - switch.turn_off:
                  id: doorman_relay
        - lock.template.publish:
            id: second_entrance_door
            state: LOCKED
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 2.0
    optimistic: false
    assumed_state: false
  - platform: nuki_lock
    name: Apartment Door
    id: apartment_door
    icon: mdi:door
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 3.0
    is_connected:
      id: nuki_connected
      name: Nuki Connected
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -30.0
      disabled_by_default: false
      icon: mdi:link
      entity_category: diagnostic
      device_class: connectivity
    is_paired:
      id: nuki_paired
      name: Nuki Paired
      web_server:
        sorting_group_id: sorting_group_nuki_bridge_settings
        sorting_weight: -29.0
      disabled_by_default: false
      icon: mdi:link
      entity_category: diagnostic
      device_class: connectivity
    battery_critical:
      id: nuki_battery_critical
      name: Nuki Battery Critical
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -28.0
      disabled_by_default: false
      icon: mdi:battery-alert-variant-outline
      entity_category: diagnostic
      device_class: battery
    battery_level:
      id: nuki_battery_level
      name: Nuki Battery Level
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -27.0
      disabled_by_default: false
      force_update: false
      unit_of_measurement: '%'
      icon: mdi:battery-50
      device_class: battery
      entity_category: diagnostic
    bt_signal_strength:
      id: nuki_bluetooth_signal_strength
      name: Nuki Bluetooth Signal Strength
      web_server:
        sorting_group_id: sorting_group_nuki
      disabled_by_default: false
      force_update: false
      unit_of_measurement: dBm
      icon: mdi:bluetooth-audio
      device_class: signal_strength
      entity_category: diagnostic
    door_sensor:
      id: nuki_door_sensor
      name: Nuki Door Sensor
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -26.0
      icon: mdi:door-open
      device_class: door
    door_sensor_state:
      id: nuki_door_sensor_state
      name: 'Nuki Door Sensor: State'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -25.0
      icon: mdi:door-open
      entity_category: diagnostic
    last_unlock_user:
      id: nuki_last_unlock_user
      name: Nuki Last Unlock User
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -24.0
      disabled_by_default: false
      icon: mdi:account-clock
      entity_category: diagnostic
    last_lock_action:
      id: nuki_last_lock_action
      name: Nuki Last Lock Action
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -23.0
      icon: mdi:account-clock
      entity_category: diagnostic
    last_lock_action_trigger:
      id: nuki_last_lock_action_trigger
      name: Nuki Last Lock Action Trigger
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -22.0
      icon: mdi:account-clock
      entity_category: diagnostic
    pin_status:
      id: nuki_pin_status
      name: Nuki Security Pin Status
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki
        sorting_weight: -29.0
      icon: mdi:shield-key
      entity_category: diagnostic
    auto_unlatch:
      id: nuki_auto_unlatch
      name: Nuki Auto unlatch
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -21.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:auto-upload
    button_enabled:
      id: nuki_button_locking_operations
      name: 'Nuki Button: Locking operations'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -20.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:radiobox-marked
    single_buton_press_action:
      id: nuki_single_button_press_action
      name: 'Nuki Button: Single Press Action'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -19.0
      entity_category: config
      icon: mdi:gesture-tap
    double_buton_press_action:
      id: nuki_double_button_press_action
      name: 'Nuki Button: Double Press Action'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -18.0
      entity_category: config
      icon: mdi:gesture-tap
    led_enabled:
      id: nuki_led_enabled
      name: 'Nuki LED: Signal'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -15.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:led-on
    led_brightness:
      id: nuki_led_brightness
      name: 'Nuki LED: Brightness'
      disabled_by_default: true
      mode: SLIDER
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -14.0
      icon: mdi:brightness-6
      entity_category: config
    night_mode_enabled:
      id: nuki_night_mode
      name: Nuki Night Mode
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: 8.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:shield-moon
    night_mode_auto_lock_enabled:
      id: nuki_night_mode_auto_lock_enabled
      name: 'Nuki Night Mode: Auto Lock'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -9.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:lock-clock
    night_mode_auto_unlock_disabled:
      id: nuki_night_mode_auto_unlock_disabled
      name: 'Nuki Night Mode: Reject Auto Unlock'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -8.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:lock-remove
    night_mode_immediate_lock_on_start_enabled:
      id: nuki_night_mode_immediate_lock_on_start
      name: 'Nuki Night Mode: Lock at Start Time'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -7.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:lock-alert
    auto_lock_enabled:
      id: nuki_auto_lock
      name: Nuki Auto Lock
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -5.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:lock-clock
    immediate_auto_lock_enabled:
      id: nuki_immediate_auto_lock
      name: 'Nuki Auto Lock: Immediately'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -4.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:lock-alert
    single_lock_enabled:
      id: nuki_single_lock
      name: Nuki Single Lock
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -4.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:lock-plus
    auto_unlock_disabled:
      id: nuki_auto_unlock_disabled
      name: 'Nuki Auto Unlock: Disable'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: -3.0
      restore_mode: ALWAYS_OFF
      device_class: switch
      entity_category: config
      icon: mdi:lock-remove
    fob_action_1:
      id: nuki_fob_action_1
      name: 'Nuki Fob: Action 1'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: 1.0
      entity_category: config
      icon: mdi:gesture-tap
    fob_action_2:
      id: nuki_fob_action_2
      name: 'Nuki Fob: Action 2'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: 2.0
      entity_category: config
      icon: mdi:gesture-tap
    fob_action_3:
      id: nuki_fob_action_3
      name: 'Nuki Fob: Action 3'
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: 3.0
      entity_category: config
      icon: mdi:gesture-tap
    advertising_mode:
      id: nuki_advertising_mode
      name: Nuki Advertising Mode
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_settings
        sorting_weight: 9.0
      entity_category: config
      icon: mdi:timer-cog
    pairing_mode:
      id: nuki_pairing_mode
      name: Nuki Pairing Mode
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_bridge_settings
        sorting_weight: 10.0
      restore_mode: ALWAYS_OFF
      entity_category: config
      icon: mdi:bluetooth
    unpair:
      id: nuki_unpair_device
      name: Nuki Unpair Device
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_nuki_bridge_settings
        sorting_weight: 11.0
      icon: mdi:link-off
      entity_category: config
    on_pairing_mode_on_action:
      - then:
          - script.execute:
              id: update_led
    on_pairing_mode_off_action:
      - then:
          - script.execute:
              id: update_led
    on_paired_action:
      - then:
          - light.turn_on:
              id: doorman_rgb_status_led
              red: 1.0
              green: 0.0
              blue: 1.0
              effect: none
              brightness: !lambda |-
                return id(doorman_rgb_status_led_brightness).state / 100.0;
              state: true
          - delay: 3s
          - script.execute:
              id: update_led
    disabled_by_default: false
    alternative_connect_mode: true
    pairing_as_app: false
    pairing_mode_timeout: 300s
    event: nuki
    query_interval_config: 3600s
    query_interval_auth_data: 3600s
    update_interval: 500ms
select:
  - platform: template
    id: door_opener_mode
    name: Door Opener Mode
    icon: mdi:door
    optimistic: true
    options:
      - Bus Telegram
      - Internal Relay
    initial_option: Bus Telegram
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -75.0
    disabled_by_default: false
    update_interval: 60s
  - platform: template
    id: esphome_logger_level_tc_bus
    name: TC:BUS Log Level
    icon: mdi:math-log
    optimistic: true
    options:
      - Disabled
      - Error
      - Warning
      - Info
      - Configuration
      - Debug
      - Verbose
    initial_option: Debug
    restore_value: true
    entity_category: config
    on_value:
      - then:
          - lambda: !lambda |-
              id(esphome_logger).set_log_level("tc_bus", i);
    web_server:
      sorting_group_id: sorting_group_debug_tools
      sorting_weight: -5.0
    disabled_by_default: false
    update_interval: 60s
  - platform: template
    id: rto_central_doors
    name: 'RTO: Central Toggle - Door Selection'
    icon: mdi:door
    optimistic: true
    options:
      - Entrance
      - Second Entrance
      - Any Entrance
      - Apartment
      - Any Entrance & Apartment
    initial_option: Entrance
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -89.0
    disabled_by_default: false
    update_interval: 60s
  - platform: template
    name: 'RTO: Entrance Door - Delay'
    id: rto_entrance_door_delay
    disabled_by_default: true
    icon: mdi:clock-end
    optimistic: true
    options:
      - 0 seconds
      - 1 second
      - 2 seconds
      - 3 seconds
      - 4 seconds
      - 5 seconds
      - 10 seconds
      - 15 seconds
      - 20 seconds
      - 25 seconds
      - Random
    initial_option: 2 seconds
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -78.0
    update_interval: 60s
  - platform: template
    name: 'RTO: Second Entrance Door - Delay'
    id: rto_second_entrance_door_delay
    disabled_by_default: true
    icon: mdi:clock-end
    optimistic: true
    options:
      - 0 seconds
      - 1 second
      - 2 seconds
      - 3 seconds
      - 4 seconds
      - 5 seconds
      - 10 seconds
      - 15 seconds
      - 20 seconds
      - 25 seconds
      - Random
    initial_option: 2 seconds
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -68.0
    update_interval: 60s
  - platform: template
    name: 'RTO: Apartment Door - Delay'
    id: rto_apartment_door_delay
    internal: false
    disabled_by_default: true
    icon: mdi:clock-end
    optimistic: true
    options:
      - 0 seconds
      - 1 second
      - 2 seconds
      - 3 seconds
      - 4 seconds
      - 5 seconds
      - 10 seconds
      - 15 seconds
      - 20 seconds
      - 25 seconds
      - Random
    initial_option: 2 seconds
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -48.0
    update_interval: 60s
  - platform: template
    id: rto_entrance_door_timeout_mode
    name: 'RTO: Entrance Door - Timeout'
    icon: mdi:clock-fast
    optimistic: true
    options:
      - Never
      - Ring once
      - 5 minutes
      - 10 minutes
      - 15 minutes
      - 20 minutes
      - 25 minutes
      - 30 minutes
      - 35 minutes
      - 40 minutes
      - 45 minutes
      - 50 minutes
      - 55 minutes
      - 60 minutes
    initial_option: Never
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -77.0
    disabled_by_default: false
    update_interval: 60s
  - platform: template
    id: rto_second_entrance_door_timeout_mode
    name: 'RTO: Second Entrance Door - Timeout'
    icon: mdi:clock-fast
    disabled_by_default: true
    optimistic: true
    options:
      - Never
      - Ring once
      - 5 minutes
      - 10 minutes
      - 15 minutes
      - 20 minutes
      - 25 minutes
      - 30 minutes
      - 35 minutes
      - 40 minutes
      - 45 minutes
      - 50 minutes
      - 55 minutes
      - 60 minutes
    initial_option: Never
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -67.0
    update_interval: 60s
  - platform: template
    id: rto_apartment_door_timeout_mode
    internal: false
    name: 'RTO: Apartment Door - Timeout'
    icon: mdi:clock-fast
    optimistic: true
    options:
      - Never
      - Ring once
      - 5 minutes
      - 10 minutes
      - 15 minutes
      - 20 minutes
      - 25 minutes
      - 30 minutes
      - 35 minutes
      - 40 minutes
      - 45 minutes
      - 50 minutes
      - 55 minutes
      - 60 minutes
    initial_option: Never
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -47.0
    disabled_by_default: false
    update_interval: 60s
  - platform: template
    id: rto_entrance_door_pattern_condition
    name: 'RTO: Entrance Door - Pattern'
    icon: mdi:gesture-tap-button
    disabled_by_default: true
    optimistic: true
    options:
      - single
      - double
      - triple
      - quadruple
    initial_option: single
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -79.0
    update_interval: 60s
  - platform: template
    id: rto_second_entrance_door_pattern_condition
    name: 'RTO: Second Entrance Door - Pattern'
    icon: mdi:gesture-tap-button
    disabled_by_default: true
    optimistic: true
    options:
      - single
      - double
      - triple
      - quadruple
    initial_option: single
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -69.0
    update_interval: 60s
  - platform: template
    id: rto_apartment_door_pattern_condition
    name: 'RTO: Apartment Door - Pattern'
    internal: false
    icon: mdi:gesture-tap-button
    disabled_by_default: true
    optimistic: true
    options:
      - single
      - double
      - triple
      - quadruple
    initial_option: single
    restore_value: true
    entity_category: config
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -49.0
    update_interval: 60s
  - platform: template
    id: rto_toggle_trigger
    name: 'RTO: Central Toggle - Trigger'
    icon: mdi:circle-outline
    optimistic: true
    options:
      - Manual
      - Function Button
      - External Button
    initial_option: Manual
    restore_value: true
    entity_category: config
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_rto_settings
      sorting_weight: -90.0
    update_interval: 60s
  - platform: tc_bus
    model:
      id: intercom_model
      name: Indoor Station Model
      icon: mdi:doorbell-video
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_settings
        sorting_weight: -97.0
    ringtone_entrance_door_call:
      id: intercom_ringtone_entrance_door_call
      name: 'Ringtone: Entrance Door Call'
      icon: mdi:music
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_intercom_settings
        sorting_weight: -80.0
    ringtone_second_entrance_door_call:
      id: intercom_ringtone_second_entrance_door_call
      name: 'Ringtone: Second Entrance Door Call'
      icon: mdi:music
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_intercom_settings
        sorting_weight: -79.0
    ringtone_floor_call:
      id: intercom_ringtone_floor_call
      name: 'Ringtone: Floor Call'
      icon: mdi:music
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_intercom_settings
        sorting_weight: -78.0
    ringtone_internal_call:
      id: intercom_ringtone_internal_call
      name: 'Ringtone: Internal Call'
      icon: mdi:music
      entity_category: config
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_intercom_settings
        sorting_weight: -77.0
event:
  - platform: template
    id: entrance_doorbell_pattern
    name: Entrance Doorbell
    icon: mdi:doorbell
    device_class: doorbell
    event_types:
      - default
      - single
      - double
      - triple
      - quadruple
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -30.0
    on_event:
      - then:
          - if:
              condition:
                and:
                  - switch.is_on:
                      id: rto_entrance_door
                  - lambda: !lambda |-
                      return event_type.c_str() != "single";
                  - lambda: !lambda |-
                      return event_type.c_str() == id(rto_entrance_door_pattern_condition).state;
              then:
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_entrance_door_timeout_mode).state == "Ring once";
                    then:
                      - switch.turn_off:
                          id: rto_entrance_door
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_entrance_door_delay).state == "Random";
                    then:
                      - delay: !lambda |-
                          return 5000 + (rand() % 10000);
                    else:
                      - delay: !lambda |-
                          std::string str = id(rto_entrance_door_delay).state;
                          size_t pos = str.find(' ');
                          std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                          int value = std::stoi(first_token);

                          // Subtract 2 seconds for the pattern offset
                          if(value < 2)
                          {
                            value = 2;
                          }
                          return (value - 2) * 1000;
                - script.execute:
                    id: rto_entrance_door_action
    disabled_by_default: false
  - platform: template
    id: second_entrance_doorbell_pattern
    name: Second Entrance Doorbell
    icon: mdi:doorbell
    device_class: doorbell
    event_types:
      - default
      - single
      - double
      - triple
      - quadruple
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -40.0
    on_event:
      - then:
          - if:
              condition:
                and:
                  - switch.is_on:
                      id: rto_second_entrance_door
                  - lambda: !lambda |-
                      return event_type.c_str() != "single";
                  - lambda: !lambda |-
                      return event_type.c_str() == id(rto_second_entrance_door_pattern_condition).state;
              then:
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_second_entrance_door_timeout_mode).state == "Ring once";
                    then:
                      - switch.turn_off:
                          id: rto_second_entrance_door
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_second_entrance_door_delay).state == "Random";
                    then:
                      - delay: !lambda |-
                          return 5000 + (rand() % 10000);
                    else:
                      - delay: !lambda |-
                          std::string str = id(rto_second_entrance_door_delay).state;
                          size_t pos = str.find(' ');
                          std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                          int value = std::stoi(first_token);

                          // Subtract 2 seconds for the pattern offset
                          if(value < 2)
                          {
                            value = 2;
                          }
                          return (value - 2) * 1000;
                - script.execute:
                    id: rto_second_entrance_door_action
    disabled_by_default: false
  - platform: template
    id: apartment_doorbell_pattern
    name: Apartment Doorbell
    icon: mdi:doorbell
    device_class: doorbell
    event_types:
      - default
      - single
      - double
      - triple
      - quadruple
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -50.0
    on_event:
      - then:
          - if:
              condition:
                and:
                  - switch.is_on:
                      id: rto_apartment_door
                  - lambda: !lambda |-
                      return event_type.c_str() != "single";
                  - lambda: !lambda |-
                      return event_type.c_str() == id(rto_apartment_door_pattern_condition).state;
              then:
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_apartment_door_timeout_mode).state == "Ring once";
                    then:
                      - switch.turn_off:
                          id: rto_apartment_door
                - if:
                    condition:
                      and:
                        - lambda: !lambda |-
                            return id(rto_apartment_door_delay).state == "Random";
                    then:
                      - delay: !lambda |-
                          return 5000 + (rand() % 10000);
                    else:
                      - delay: !lambda |-
                          std::string str = id(rto_apartment_door_delay).state;
                          size_t pos = str.find(' ');
                          std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                          int value = std::stoi(first_token);

                          // Subtract 2 seconds for the pattern offset
                          if(value < 2)
                          {
                            value = 2;
                          }
                          return (value - 2) * 1000;
                - script.execute:
                    id: rto_apartment_door_action
    disabled_by_default: false
  - platform: template
    id: phone_pick_up_pattern
    name: Phone pick up
    icon: mdi:phone-incoming-outgoing
    event_types:
      - default
      - single
      - double
      - triple
      - quadruple
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -20.0
    disabled_by_default: false
script:
  - id: blink_status_led
    mode: restart
    then:
      - light.turn_off:
          id: doorman_status_led
          state: false
      - light.turn_on:
          id: doorman_status_led
          state: true
      - delay: 100ms
      - light.turn_off:
          id: doorman_status_led
          state: false
    parameters: {}
  - id: send_telegram_chain
    parameters:
      telegram_list: string
    then:
      - lambda: !lambda |-
          size_t start = 0;
          size_t end;

          while ((end = telegram_list.find(';', start)) != std::string::npos) {
              std::string token = telegram_list.substr(start, end - start);

              // Remove non-hex characters
              token.erase(std::remove_if(token.begin(), token.end(), [](char c) {
                  return !std::isxdigit(static_cast<unsigned char>(c));
              }), token.end());

              if (token.length() == 4 || token.length() == 8) {
                  const char* str = token.c_str();
                  char* endptr = nullptr;
                  errno = 0;  // Reset errno before call
                  unsigned long number = std::strtoul(str, &endptr, 16);

                  // Check if entire string was converted and no errors occurred
                  if (endptr == str + token.size() && errno == 0) {
                      if (token.length() == 8) {
                          id(tc_bus_intercom)->send_telegram(number, true);
                      } else {
                          id(tc_bus_intercom)->send_telegram(number);
                      }
                  }
              }
              start = end + 1;
          }

          // Handle last token
          std::string token = telegram_list.substr(start);
          token.erase(std::remove_if(token.begin(), token.end(), [](char c) {
              return !std::isxdigit(static_cast<unsigned char>(c));
          }), token.end());

          if (token.length() == 4 || token.length() == 8) {
              const char* str = token.c_str();
              char* endptr = nullptr;
              errno = 0;
              unsigned long number = std::strtoul(str, &endptr, 16);
              if (endptr == str + token.size() && errno == 0) {
                  if (token.length() == 8) {
                      id(tc_bus_intercom)->send_telegram(number, true);
                  } else {
                      id(tc_bus_intercom)->send_telegram(number);
                  }
              }
          }
    mode: single
  - id: update_led
    then:
      - logger.log:
          format: Conditionally set LED State
          tag: main
          level: DEBUG
          args: []
      - light.turn_off:
          id: doorman_rgb_status_led
          transition_length: 1s
          state: false
      - if:
          condition:
            and:
              - lambda: !lambda "return id(rto_entrance_door).state || \n       id(rto_second_entrance_door).state\
                  \ || \n       id(rto_apartment_door).state;"
              - switch.is_on:
                  id: rto_led_status
          then:
            - light.turn_on:
                id: doorman_rgb_status_led
                red: 1.0
                green: 1.0
                blue: 0.03
                effect: slow_pulse
                state: true
      - if:
          condition:
            and:
              - switch.is_on:
                  id: nuki_pairing_mode
          then:
            - light.turn_on:
                id: doorman_rgb_status_led
                red: 1.0
                green: 0.0
                blue: 1.0
                effect: pulse
                state: true
      - if:
          condition:
            and:
              - switch.is_on:
                  id: doorman_setup_mode
          then:
            - light.turn_on:
                id: doorman_rgb_status_led
                red: 0.0
                green: 1.0
                blue: 0.1
                effect: pulse
                state: true
    mode: single
    parameters: {}
  - id: rto_entrance_door_timer
    mode: restart
    then:
      - if:
          condition:
            and:
              - lambda: !lambda "return id(rto_entrance_door_timeout_mode).state !=\
                  \ \"Never\" && \n       id(rto_entrance_door_timeout_mode).state\
                  \ != \"Ring once\";"
          then:
            - delay: !lambda |-
                std::string str = id(rto_entrance_door_timeout_mode).state;
                size_t pos = str.find(' ');
                std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                int value = std::stoi(first_token);
                ESP_LOGD("main", "RTO: Entrance Door will stay turned on for %i minutes", value);
                return value * 60 * 1000;
            - switch.turn_off:
                id: rto_entrance_door
    parameters: {}
  - id: rto_second_entrance_door_timer
    mode: restart
    then:
      - if:
          condition:
            and:
              - lambda: !lambda |-
                  return id(rto_second_entrance_door_timeout_mode).state != "Never" &&
                         id(rto_second_entrance_door_timeout_mode).state != "Ring once";
          then:
            - delay: !lambda |-
                std::string str = id(rto_second_entrance_door_timeout_mode).state;
                size_t pos = str.find(' ');
                std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                int value = std::stoi(first_token);
                ESP_LOGD("main", "RTO: Second Entrance Door will stay turned on for %i minutes", value);
                return value * 60 * 1000;
            - switch.turn_off:
                id: rto_second_entrance_door
    parameters: {}
  - id: rto_apartment_door_timer
    mode: restart
    then:
      - if:
          condition:
            and:
              - lambda: !lambda "return id(rto_apartment_door_timeout_mode).state\
                  \ != \"Never\" && \n       id(rto_apartment_door_timeout_mode).state\
                  \ != \"Ring once\";"
          then:
            - delay: !lambda |-
                std::string str = id(rto_apartment_door_timeout_mode).state;
                size_t pos = str.find(' ');
                std::string first_token = (pos != std::string::npos) ? str.substr(0, pos) : str;
                int value = std::stoi(first_token);
                ESP_LOGD("main", "RTO: Apartment Door will stay turned on for %i minutes", value);
                return value * 60 * 1000;
            - switch.turn_off:
                id: rto_apartment_door
    parameters: {}
  - id: rto_entrance_door_action
    then:
      - logger.log:
          format: 'RTO: Execute Entrance Door Action'
          tag: main
          level: DEBUG
          args: []
      - lock.unlock:
          id: entrance_door
    mode: single
    parameters: {}
  - id: rto_second_entrance_door_action
    then:
      - logger.log:
          format: 'RTO: Execute Second Entrance Door Action'
          tag: main
          level: DEBUG
          args: []
      - lock.unlock:
          id: second_entrance_door
    mode: single
    parameters: {}
  - id: rto_apartment_door_action
    then:
      - logger.log:
          format: 'RTO: Execute Apartment Door Action'
          tag: main
          level: DEBUG
          args: []
      - lock.open:
          id: apartment_door
    mode: single
    parameters: {}
  - id: complete_setup
    then:
      - switch.turn_off:
          id: doorman_setup_mode
      - light.turn_on:
          id: doorman_rgb_status_led
          red: 0.0
          green: 1.0
          blue: 0.1
          effect: none
          brightness: !lambda |-
            return id(doorman_rgb_status_led_brightness).state / 100.0;
          state: true
      - delay: 3s
      - script.execute:
          id: update_led
      - logger.log:
          format: Setup completed.
          tag: main
          level: DEBUG
          args: []
    mode: single
    parameters: {}
ota:
  - platform: http_request
    id: ota_http_request
  - platform: esphome
    id: ota_esphome
    version: 2
    port: 3232
http_request:
  verify_ssl: false
  useragent: ESPHome/2025.8.0-dev (https://esphome.io)
  follow_redirects: true
  redirect_limit: 3
  timeout: 4500ms
  buffer_size_rx: 512
  buffer_size_tx: 512
update:
  - platform: http_request
    id: update_http_request
    icon: mdi:update
    name: Doorman Firmware Update
    source: https://doorman.azon.ai/firmware/release/esp32-s3-quad.custom.nuki-bridge/manifest.json
    update_interval: 1h
    disabled_by_default: false
    web_server:
      sorting_group_id: sorting_group_updates
      sorting_weight: 99.0
    setup_priority: -100.0
    entity_category: config
globals:
  - id: search_mode
    type: int
    restore_value: false
    initial_value: '0'
  - id: as_list
    type: std::vector<int>
    initial_value: ''
    restore_value: false
  - id: is0_list
    type: std::vector<int>
    initial_value: ''
    restore_value: false
  - id: is1_list
    type: std::vector<int>
    initial_value: ''
    restore_value: false
  - id: extra_list
    type: std::vector<int>
    initial_value: ''
    restore_value: false
  - id: controller_list
    type: std::vector<int>
    initial_value: ''
    restore_value: false
debug:
  update_interval: 5s

